<!DOCTYPE html>
<!-- DoNotFormat -->
<!-- DoNotFormat -->




<!-- DoNotFormat -->
<!-- DoNotFormat -->

<html lang='en'>

<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>
    Leveraging Cap'n Proto For Logreduce Reports – Tristan's Zettelkasten
  </title>
  
    
      <meta property='og:description' content='This post was initially published on the Software Factory blog: https://www.softwarefactory-project.io/leveraging-capn-proto-for-logreduce-reports.html' />
      <meta property='og:site_name' content="Tristan's Zettelkasten" />
      <meta property='og:image' content='https://tristancacqueray.github.io/' />
      <meta property='og:type' content='website' />
      <meta property='og:title' content="Leveraging Cap'n Proto For Logreduce Reports" />
      
        <meta name='twitter:card' content='summary_large_image' />
      
    
    
      <base href='/' />
      <link href='/static/favicon.jpeg' rel='icon' />
    
    <!-- highlight.js -->
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/hybrid.min.css' />
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js'></script>
<!-- Include languages that Emanote itself uses -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/haskell.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/nix.min.js'></script>
<script>hljs.highlightAll();</script>



<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/lisp.min.js'></script>

<!-- mermaid.js --><script type='module'>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.init(undefined,document.querySelectorAll(".mermaid"));
</script>

<script>
window.MathJax = {
  startup: {
    ready: () => {MathJax.startup.defaultReady();}
  }
};
</script>
<script async id='MathJax-script' src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script>

  
  
  <link href='tailwind.css?instanceId=552ed003-b63e-4d1f-b310-47a5f6359f0d' rel='stylesheet' type='text/css' />

  <style>
    /* Heist error element */
    strong.error {
      color: lightcoral;
      font-size: 90%;
      font-family: monospace;
    }

    /* Callouts */
    div.callout {
      background-color: #f5f5f5;
      padding: 1em 1em 0.5em;
      border-radius: 0.5em;
      margin-bottom: 1em;
    }

    .callout[data-callout="note"] {
      --callout-color: 8, 109, 221;
    }

    .callout[data-callout="info"] {
      --callout-color: 8, 109, 221;
    }

    .callout[data-callout="tip"] {
      --callout-color: 8, 191, 188;
    }

    .callout[data-callout="warning"] {
      --callout-color: 236, 117, 0;
    }

    .callout[data-callout="failure"] {
      --callout-color: 233, 49, 71;
    }

    div.callout {
      background-color: rgba(var(--callout-color), 0.1);
    }

    .callout .callout-title {
      color: rgb(var(--callout-color));
    }

    div.callout-title {
      display: flex;
      align-items: center;
      margin-bottom: 0.5em;
      font-variation-settings: 'wght' 600;
    }

    div.callout-title div.callout-title-inner {
      margin-left: 0.5em;
    }

    a.--ema-toc:not(.toc-item-active) {
      background-color: #ffffff !important;
    }

    /* External link icon */
    a[data-linkicon=""]::after {
      content: ""
    }

    a[data-linkicon=none]::after {
      content: ""
    }

    a[data-linkicon="external"] {
      padding-right: 24px;
    }
    a[data-linkicon="external"]::after {
      margin-right: -24px;
      content: url('data:image/svg+xml,\
      <svg xmlns="http://www.w3.org/2000/svg" height="0.7em" viewBox="0 0 20 20"> \
        <g style="stroke:gray;stroke-width:1"> \
          <line x1="5" y1="5" x2="5" y2="14" /> \
          <line x1="14" y1="9" x2="14" y2="14" /> \
          <line x1="5" y1="14" x2="14" y2="14" /> \
          <line x1="5" y1="5" x2="9" y2="5"  /> \
          <line x1="10" y1="2" x2="17" y2="2"  /> \
          <line x1="17" y1="2" x2="17" y2="9" /> \
          <line x1="10" y1="9" x2="17" y2="2" style="stroke-width:1.0" /> \
        </g> \
      </svg>');
    }

    a[data-linkicon="external"][href^="mailto:"]::after {
      content: url('data:image/svg+xml,\
        <svg \
          xmlns="http://www.w3.org/2000/svg" \
          height="0.7em" \
          fill="none" \
          viewBox="0 0 24 24" \
          stroke="gray" \
          stroke-width="2"> \
          <path \
            stroke-linecap="round" \
            stroke-linejoin="round" \
            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /> \
        </svg>');
    }
  </style>
  <!-- What goes in this file will appear on near the end of <head>--><link rel='preload' href='_emanote-static/fonts/Work_Sans/WorkSans-VariableFont_wght.ttf' as='font' type='font/ttf' crossorigin />

<style>
  @font-face {
    font-family: 'WorkSans';
    /* FIXME: This ought to be: ${ema:emanoteStaticLayerUrl}/fonts/Work_Sans/WorkSans-VariableFont_wght.ttf */
    src: url(_emanote-static/fonts/Work_Sans/WorkSans-VariableFont_wght.ttf) format("truetype");
    font-display: swap;
  }

  body {
    font-family: 'WorkSans', sans-serif;
    font-variation-settings: 'wght' 350;
  }

  a.mavenLinkBold {
    font-variation-settings: 'wght' 400;
  }

  strong {
    font-variation-settings: 'wght' 500;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  header,
  .header-font {
    font-family: 'WorkSans', sans-serif;
  }

  h1 {
    font-variation-settings: 'wght' 500;
  }

  h2 {
    font-variation-settings: 'wght' 400;
  }

  h3 {
    font-variation-settings: 'wght' 300;
  }
</style>


  
    <style>
      /* For use in sidebar.tpl, as we cannot achieve this in tailwind itself! */
      /* md:min-w-48  */
      @media (min-width: 768px) {
        #sidebar {
          min-width: 12rem;
        }
      }

      /* xl:min-w-64  */
      @media (min-width: 1280px) {
        #sidebar {
          min-width: 16rem;
        }
      }
    </style>

    
      <link rel='stylesheet' href='_emanote-static/inverted-tree.css' />
    
  
  <link rel='stylesheet' href='_emanote-static/stork/flat.css' />
<!-- Custom Stork-search styling for Emanote -->
<style>
  #stork-search-container {
    z-index: 1000;
    background-color: rgb(15 23 42/.8);
  }

  .stork-overflow-hidden-important {
    overflow: hidden !important;
  }
</style>


<script src='_emanote-static/stork/stork.js'></script>

  
    <script id='emanote-stork' data-emanote-base-url='/'>
      window.emanote = {};
      window.emanote.stork = {
        searchShown: false,
        indexIsStale: false,
        toggleSearch: function () {
          window.emanote.stork.refreshIndex();
          document.getElementById('stork-search-container').classList.toggle('hidden');
          window.emanote.stork.searchShown = document.body.classList.toggle('stork-overflow-hidden-important');
          if (window.emanote.stork.searchShown) {
            document.getElementById('stork-search-input').focus();
          }
        },
        clearSearch: function () {
          document.getElementById('stork-search-container').classList.add('hidden');
          document.body.classList.remove('stork-overflow-hidden-important');
          window.emanote.stork.searchShown = false;
        },

        getBaseUrl: function () {
          const baseUrl = document.getElementById("emanote-stork").getAttribute('data-emanote-base-url') || '/';
          return baseUrl;
        },

        registerIndex: function (options) {
          const indexName = 'emanote-search'; // used to match input[data-stork] attribute value
          const indexUrl = window.emanote.stork.getBaseUrl() + '-/stork.st';
          stork.register(
            indexName,
            indexUrl,
            options);
        },

        init: function () {
          if (document.readyState !== 'complete') {
            window.addEventListener('load', function () {
              stork.initialize(window.emanote.stork.getBaseUrl() + '_emanote-static/stork/stork.wasm');
              window.emanote.stork.registerIndex();
            });

            document.addEventListener('keydown', event => {
              if (window.emanote.stork.searchShown && event.key === 'Escape') {
                window.emanote.stork.clearSearch();
                event.preventDefault();
              } else if ((event.key == 'k' || event.key == 'K') && (event.ctrlKey || event.metaKey)) {
                window.emanote.stork.toggleSearch();
                event.preventDefault();
              }
            });
          } else {
            // This section is called during Ema's hot reload.
            // 
            // Mark the current index as stale, and refresh it *only when* the
            // user actually invokes search.
            // 
            // We do not refresh the index *right away*, as that will cause
            // memory leaks in the browser. See
            // https://github.com/srid/emanote/issues/411#issuecomment-1402056235
            console.log("stork: Marking index as stale");
            window.emanote.stork.markIndexAsStale();
          }
        },

        markIndexAsStale: function () {
          window.emanote.stork.indexIsStale = true;
        },

        refreshIndex: function () {
          if (window.emanote.stork.indexIsStale) {
            console.log("stork: Reloading index");
            window.emanote.stork.indexIsStale = false;
            // NOTE: This will leak memory. See the comment above.
            window.emanote.stork.registerIndex({ forceOverwrite: true });
          }
        }

      };

      window.emanote.stork.init();
    </script>
  

</head>

<!-- DoNotFormat -->



<!-- DoNotFormat -->

<body class='bg-gray-400 overflow-y-scroll'>
  
    <div class='container mx-auto w-[67rem] mt-2 md:mt-4  '>
      
        <!-- DoNotFormat -->
<!-- DoNotFormat -->

<nav id='uptree' class='flipped tree' style='transform-origin: 50%;'>
  <ul class='root'>
    <li>
      
        <ul>
          
            <li>

  <a href='blog'>
    <div class='text-gray-900 hover:bg-blue-500 hover:text-white cursor-pointer forest-link'>
      Blog
    </div>
  </a>

  
    <ul>
      
        <li>

  <a href=''>
    <div class='text-gray-900 hover:bg-blue-500 hover:text-white cursor-pointer forest-link'>
      Tristan de Cacqueray
    </div>
  </a>

  
</li>
      
    </ul>
  
</li>
          
        </ul>
      
    </li>
  </ul>
</nav>
      

      

      
        <div id='container' class='relative md:shadow-2xl md:mb-8'>
          
  <div class='absolute -top-6 right-1 md:right-0 flex flex-row items-center justify-center'>
    <a title='Search (Ctrl+K)' class='cursor-pointer' onclick='window.emanote.stork.toggleSearch()'>
      <svg xmlns='http://www.w3.org/2000/svg' style='width: 1rem;' class='hover:text-blue-700' f
 fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'>
  <path stroke-linecap='round' stroke-linejoin='round' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'></path>
</svg>
    </a>
  </div>

          <!-- Main body column -->
          <div class='flex-1 w-full bg-white'>
  <main class='px-4 py-4'>
    <h1 class='flex items-end justify-center mb-4 p-3 bg-blue-100 text-5xl font-extrabold text-black rounded'>
  <a class='z-40 tracking-tighter '>
    Leveraging Cap'n Proto For Logreduce Reports
  </a>
</h1>
    
      <div class='md:grid md:gap-4 md:grid-cols-8'>
        <div class='md:col-span-6'>
          <article class='overflow-auto'>
  <!-- What goes in this file will appear on top of note body-->
  






    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      This post was initially published on the Software Factory blog: <a href='https://www.softwarefactory-project.io/leveraging-capn-proto-for-logreduce-reports.html' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>https://www.softwarefactory-project.io/leveraging-capn-proto-for-logreduce-reports.html</a>
    </p>
  
    </blockquote>
  
    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      This post is a follow-up on the previous <a href='blog/logreduce-web-interface-wasm' class='text-blue-600 mavenLinkBold hover:underline' data-wikilink-type='WikiLinkNormal'>Logreduce WASM based web interface</a> article.
    </p>
  
    </blockquote>
  
    <p class='mb-3'>
      This post describes why and how I used <a href='https://capnproto.org/' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Cap’n Proto</a> for the <a href='https://github.com/logreduce/logreduce#readme' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>logreduce</a> reports format. In three parts, I present:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          Bincode versioning scheme.
        </li>
      
        <li>
          Cap’n Proto.
        </li>
      
        <li>
          Logreduce report encoder/decoder.
        </li>
      
    </ul>
  
    <h2 id='context-and-problem-statement' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Context and problem statement
  
  <a href='blog/logreduce-capn-proto#context-and-problem-statement' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      Logreduce is a tool that searches for anomalies in build logs. It can produce reports displayable on web browsers. Logreduce used to distribute an HTML file setup with a compatible rendering client. However, in the context of the new web service interface, the client may now display reports that were created by an older version of logreduce.
    </p>
  
    <p class='mb-3'>
      The problem is that the report format didn’t guarantee backward compatibility: clients were not able to read reports saved in a previous version.
    </p>
  
    <p class='mb-3'>
      I evaluated the following formats to solve this problem:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          <a href='https://protobuf.dev/' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Protobuf</a>, introduced by Google in 2001.
        </li>
      
        <li>
          <a href='https://thrift.apache.org/' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Thrift</a>, introduced by Facebook in 2007.
        </li>
      
        <li>
          <a href='https://capnproto.org/' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Cap’n Proto</a>, introduced by the former maintainer of Protobuf in 2013.
        </li>
      
        <li>
          <a href='https://flatbuffers.dev/' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Flatbuffers</a>, introduced by Google in 2014.
        </li>
      
    </ul>
  
    <p class='mb-3'>
      Cap’n Proto and Flatbuffers are modern formats designed for performance-critical applications. They both enable access to the data without parsing/unpacking, using a process known as zero-copy serialization, which is a great feature for logreduce. Flatbuffers was originally created for games development and it doesn’t perform data validation by default. Therefore I decided to use Cap’n Proto as discussed in the next sections.
    </p>
  
    <h2 id='bincode-versioning-scheme' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Bincode versioning scheme
  
  <a href='blog/logreduce-capn-proto#bincode-versioning-scheme' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      In this section I present the main challenge of using bincode to save data. Previously, logreduce used bincode to exchange reports.
    </p>
  
    <h3 id='prepare-the-playground' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Prepare the playground
  
  <a href='blog/logreduce-capn-proto#prepare-the-playground' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      For the purpose of this article, we’ll create a standalone playground.
    </p>
  
    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      If you don’t have <code class='py-0.5 px-0.5 bg-gray-100'>cargo</code>, see this <a href='https://www.rust-lang.org/tools/install' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>install rust</a> documentation.
    </p>
  
    </blockquote>
  
    <p class='mb-3'>
      Setup a new project:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo new capnp-playground
$ cd capnp-playground</code></pre></div>
    <p class='mb-3'>
      Add dependencies:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo add bincode@1.3</code></pre></div>
    <p class='mb-3'>
      Add serde with the derive feature to generate the encoder/decoder:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo add serde@1.0 --features derive</code></pre></div>
    <p class='mb-3'>
      And build everything:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo run
Hello, world!</code></pre></div>
    <h3 id='create-the-initial-report' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Create the initial report
  
  <a href='blog/logreduce-capn-proto#create-the-initial-report' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      Add the following code to demonstrate bincode usage in the <code class='py-0.5 px-0.5 bg-gray-100'>src/main.rs</code> file:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>// Copyright (C) 2023 Red Hat
// SPDX-License-Identifier: Apache-2.0

// This program demonstrates data type serialization.
// It does not handle exceptions and unwrap is used to keep the code short.

use serde::{Deserialize, Serialize};
use std::fs::File;

#[derive(Debug, Serialize, Deserialize)]
struct Report {
    baselines: Vec&lt;Content&gt;,
    // list of anomaly omitted
}

#[derive(Debug, Serialize, Deserialize)]
enum Content {
    Zuul {
        change: u64,
        job: String,
    },
    Prow {
        pr: u64,
        url: String,
    },
}

fn encode(report: &amp;Report, file: &amp;str) {
    println!("{}: saving report", file);
    let file = File::create(file).unwrap();
    bincode::serialize_into(file, report).unwrap();
}

fn decode(file: &amp;str) -&gt; Report {
    println!("{}: loading report", file);
    let file = File::open(file).unwrap();
    bincode::deserialize_from(file).unwrap()
}

fn main() {
    match &amp;std::env::args().collect::&lt;Vec&lt;_&gt;&gt;()[..] {
        [_, cmd, fp] if cmd == "encode" =&gt; {
            let report = Report {
                baselines: vec![Content::Zuul {
                    change: 42,
                    job: "test".to_string(),
                }],
            };
            encode(&amp;report, fp);
        }
        [_, cmd, fp] if cmd == "decode" =&gt; {
            let report = decode(fp);
            println!("got: {:?}", report);
        }
        _ =&gt; eprintln!("usage: encode|decode file"),
    };
}</code></pre></div>
    <p class='mb-3'>
      Run the following commands to perform a serialization round trip:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo run -- encode report.bin
report.bin: saving report

$ cargo run -- decode report.bin
report.bin: loading report
got: Report { baselines: [Zuul { change: 42, job: "test" }] }</code></pre></div>
    <h3 id='updating-the-schema' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Updating the schema
  
  <a href='blog/logreduce-capn-proto#updating-the-schema' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      Update the schema, for example, by adding a new field to the Zuul structure:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='diff language-diff'>--- a/src/main.rs
+++ b/src/main.rs
@@ -14,6 +14,7 @@ enum Content {
     Zuul {
         change: u64,
         job: String,
+        project: String,
     },
     Prow {
         pr: u64,

@@ -38,6 +38,7 @@ fn main() {
                 baselines: vec![Content::Zuul {
                     change: 42,
                     job: "test".to_string(),
+                    project: "demo".to_string(),
                 }],
             };
             encode(&amp;report, fp);</code></pre></div>
    <p class='mb-3'>
      Now, decoding the initial report produces this error:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo run -- decode report.bin
report.bin: loading report
thread 'main' panicked at src/main.rs:42:37:
called `Result::unwrap()` on an `Err` value: Io(Error {
  kind: UnexpectedEof,
  message: "failed to fill whole buffer"
})</code></pre></div>
    <p class='mb-3'>
      That is expected: bincode is not able to deserialize the previous report because it now expects that Zuul builds have a project. To address that, we need to use a versioning scheme, for example with such a data type:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>enum Report {
  V1(ReportV1),
  V2(ReportV2)
}</code></pre></div>
    <p class='mb-3'>
      As long as we only append new variants, bincode is able to decode reports saved in a previous version. However this is not very practical because any change will introduce a new top level version.
    </p>
  
    <p class='mb-3'>
      Moreover, bincode doesn’t check the enum tag. If we move the <code class='py-0.5 px-0.5 bg-gray-100'>Prow</code> variant at the top of the <code class='py-0.5 px-0.5 bg-gray-100'>Content</code> declaration, then bincode will happily load the report using the wrong tag because the existing data fits the shape.
    </p>
  
    <p class='mb-3'>
      In the next section, I introduce a different format to handle versioning efficiently.
    </p>
  
    <h2 id='introducing-capn-proto' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Introducing Cap’n Proto
  
  <a href='blog/logreduce-capn-proto#introducing-capn-proto' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      Cap’n Proto is a fast data interchange format. The main benefits are:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          strongly-typed schema with first class support for <a href='https://en.wikipedia.org/wiki/Algebraic_data_type' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>algebraic data types</a> and generic types.
        </li>
      
        <li>
          backward compatible message.
        </li>
      
        <li>
          zero-copy serialization.
        </li>
      
    </ul>
  
    <h3 id='schema-language' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Schema Language
  
  <a href='blog/logreduce-capn-proto#schema-language' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      The data format is defined using a special language. Here is the schema for the report used in the playground above, copy this to a file named <code class='py-0.5 px-0.5 bg-gray-100'>schema.capnp</code> at the root of the project:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='capnp language-capnp'>@0xa0b4401e03756e61;

struct Report {
  baselines @0 :List(Content);
}

struct Content {
  union {
    zuul    @0 :Zuul;
    prow    @1 :Prow;
  }

  struct Zuul {
    change  @0 :UInt64;
    job     @1 :Text;
    project @2 :Text;
  }

  struct Prow {
    pr      @0 :UInt64;
    url     @1 :Text;
  }
}</code></pre></div>
    <p class='mb-3'>
      This should be self explanatory. Checkout the full logreduce report schema in this <a href='https://github.com/logreduce/logreduce/blob/main/crates/report/schema.capnp' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>report/schema.capnp</a>, and the <a href='https://capnproto.org/language.html' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>language documentation</a> to learn more about it.
    </p>
  
    <h3 id='code-generation' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Code generation
  
  <a href='blog/logreduce-capn-proto#code-generation' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      Cap’n Proto provides a compiler named <code class='py-0.5 px-0.5 bg-gray-100'>capnpc</code> to generate code for <a href='https://capnproto.org/otherlang.html' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>various languages</a>. Copy the following build instructions to a file named <code class='py-0.5 px-0.5 bg-gray-100'>build.rs</code> at the root of the project:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>fn main() {
    capnpc::CompilerCommand::new()
        .file("schema.capnp")
        .output_path("generated/")
        .run()
        .expect("compiling schema.capnp");
}</code></pre></div>
    <p class='mb-3'>
      Get the compiler by installing <code class='py-0.5 px-0.5 bg-gray-100'>capnproto</code> using your favorite package manager, then run the following commands to generate the code:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo add --build capnpc@0.18 && cargo add capnp@0.18
$ cargo build</code></pre></div>
    <p class='mb-3'>
      Integrate the generated code in the <code class='py-0.5 px-0.5 bg-gray-100'>main.rs</code> file by adding:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>mod schema_capnp {
    #![allow(dead_code, unused_qualifications)]
    include!("../generated/schema_capnp.rs");
}</code></pre></div>
    <p class='mb-3'>
      This setup introduces new Reader and Builder data types to read and write reports according to the schema definition.
    </p>
  
    <p class='mb-3'>
      In the next section I show how to use the new data types.
    </p>
  
    <h2 id='report-encoderdecoder' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Report Encoder/Decoder
  
  <a href='blog/logreduce-capn-proto#report-encoderdecoder' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      As an example usage of the generated data types, we can implement an encoder/decoder for the existing report struct.
    </p>
  
    <h3 id='encode-a-report' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Encode a report
  
  <a href='blog/logreduce-capn-proto#encode-a-report' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      Here is how to write a report using the <code class='py-0.5 px-0.5 bg-gray-100'>capnp::message</code> module:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>// This function write the report to the argument implementing the Write trait.
fn capnp_encode(report: &amp;Report, write: impl capnp::io::Write) {
    // Prepare a report message builder
    let mut message = capnp::message::Builder::new_default();
    let mut report_builder = message.init_root::&lt;schema_capnp::report::Builder&gt;();

    // Write a single content.
    fn write_content(content: &amp;Content, builder: schema_capnp::content::Builder) {
        match content {
            Content::Zuul {
                change,
                job,
                project,
            } =&gt; {
                // Prepare a zuul builder.
                let mut builder = builder.init_zuul();
                // Write the fields
                builder.set_change(*change);
                builder.set_job(job.as_str().into());
                builder.set_project(project.as_str().into());
            }
            Content::Prow { pr, url } =&gt; {
                // Prepare a prow builder.
                let mut builder = builder.init_prow();
                // Write the fields
                builder.set_pr(*pr);
                builder.set_url(url.as_str().into());
            }
        }
    }

    // Write the baselines vector
    {
        // Prepare the list builder.
        let mut baselines_builder = report_builder
            .reborrow()
            .init_baselines(report.baselines.len() as u32);

        for (idx, content) in report.baselines.iter().enumerate() {
            // Prepare the list element builder.
            let content_builder = baselines_builder.reborrow().get(idx as u32);
            // Write the individual baseline.
            write_content(content, content_builder);
        }
    }

    // Write the message
    capnp::serialize::write_message(write, &amp;message).unwrap();
}</code></pre></div>
    <p class='mb-3'>
      Update the encode helper:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='diff language-diff'>@@ -29,7 +84,7 @@ enum Content {
 fn encode(report: &amp;Report, file: &amp;str) {
     println!("{}: saving report", file);
     let file = File::create(file).unwrap();
-    bincode::serialize_into(file, report).unwrap();
+    capnp_encode(report, file)
 }</code></pre></div>
    <p class='mb-3'>
      Run the following command to demonstrate the encoding:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo run -- encode report.msg
report.msg: saving report</code></pre></div>
    <h3 id='decode-a-report' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Decode a report
  
  <a href='blog/logreduce-capn-proto#decode-a-report' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      Here is how to read a report:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>// This function read the report from the argument implementing the BufRead trait.
fn capnp_decode(bufread: impl capnp::io::BufRead) -&gt; Report {
    let message_reader =
        capnp::serialize::read_message(bufread, capnp::message::ReaderOptions::new()).unwrap();

    let report_reader = message_reader
        .get_root::&lt;schema_capnp::report::Reader&lt;'_&gt;&gt;()
        .unwrap();

    fn read_content(reader: &amp;schema_capnp::content::Reader) -&gt; Content {
        use schema_capnp::content::Which;
        // Read the generated union data type
        match reader.which().unwrap() {
            Which::Zuul(reader) =&gt; {
                // Prepare the reader
                let reader = reader.unwrap();
                // Read the fields
                let change = reader.get_change();
                let job = reader.get_job().unwrap().to_str().unwrap().into();
                let project = reader.get_project().unwrap().to_str().unwrap().into();
                Content::Zuul {
                    change,
                    job,
                    project,
                }
            }
            Which::Prow(reader) =&gt; {
                // Prepare the reader
                let reader = reader.unwrap();
                // Read the fields
                let pr = reader.get_pr();
                let url = reader.get_url().unwrap().to_str().unwrap().into();
                Content::Prow { pr, url }
            }
        }
    }

    // Read the baselines vector
    let baselines = {
        // Prepare the reader
        let reader = report_reader.get_baselines().unwrap();
        // Read the baselines
        let mut vec = Vec::with_capacity(reader.len() as usize);
        for reader in reader.into_iter() {
            vec.push(read_content(&amp;reader));
        }
        vec
    };

    Report { baselines }
}</code></pre></div>
    <p class='mb-3'>
      Update the decode helper:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='diff language-diff'>@@ -90,7 +142,7 @@ fn encode(report: &amp;Report, file: &amp;str) {
 fn decode(file: &amp;str) -&gt; Report {
     println!("{}: loading report", file);
     let file = File::open(file).unwrap();
-    bincode::deserialize_from(file).unwrap()
+    capnp_decode(std::io::BufReader::new(file))
 }</code></pre></div>
    <p class='mb-3'>
      Run the following command to demonstrate the decoding:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo run -- decode report.msg
report.msg: loading report
got: Report { baselines: [Zuul { change: 42, job: "test", project: "demo" }] }</code></pre></div>
    <p class='mb-3'>
      This concludes the serialization round trip demonstration using Cap’n Proto. In the next section I show how to update the schema.
    </p>
  
    <h3 id='evolving-the-schema' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Evolving the schema
  
  <a href='blog/logreduce-capn-proto#evolving-the-schema' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      In this section, we’ll perform a schema update like we did earlier.
    </p>
  
    <p class='mb-3'>
      Cap’n Proto prescribes a list of rules to preserve backward compability. For example, it is not possible to remove fields, they can only be marked as obsolete, and their memory location will always be reserved.
    </p>
  
    <p class='mb-3'>
      It is of course possible to add new fields. For example, here is how to add a title field to the report struct:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='diff language-diff'>diff --git a/schema.capnp b/schema.capnp
index add50b9..cd9e996 100644
--- a/schema.capnp
+++ b/schema.capnp
@@ -2,6 +2,7 @@

 struct Report {
   baselines @0 :List(Content);
+  title     @1 :Text;
 }

diff --git a/src/main.rs b/src/main.rs
index 09fc740..40411ad 100644
--- a/src/main.rs
+++ b/src/main.rs
@@ -15,6 +15,7 @@
 #[derive(Debug, Serialize, Deserialize)]
 struct Report {
     baselines: Vec&lt;Content&gt;,
+    title: String,
     // list of anomaly omitted
 }
@@ -58,6 +58,8 @@ fn capnp_encode(report: &amp;Report, write: impl capnp::io::Write) {
         }
     }

+    report_builder.set_title(report.title.as_str().into());

     // Write the message
     capnp::serialize::write_message(write, &amp;message).unwrap();
 }
@@ -111,12 +113,15 @@ fn capnp_decode(bufread: impl capnp::io::BufRead) -&gt; Report {
         vec
     };

-    Report { baselines }
+    let title = report_reader.get_title().unwrap().to_str().unwrap().into();
+
+    Report { baselines, title }
 }
@@ -149,6 +154,7 @@ fn main() {
     match &amp;std::env::args().collect::&lt;Vec&lt;_&gt;&gt;()[..] {
         [_, cmd, fp] if cmd == "encode" =&gt; {
             let report = Report {
+                title: "test title".to_string(),
                 baselines: vec![Content::Zuul {
                     change: 42,
                     job: "test".to_string(),</code></pre></div>
    <p class='mb-3'>
      Run this command to demonstrate we can read the report previously saved:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo run -- decode ./report.msg
report.msg: loading report
got: Report { baselines: [Zuul { change: 42, job: "test", project: "demo" }], title: "" }</code></pre></div>
    <p class='mb-3'>
      The decoding succeeded and the report title field got the default value.
    </p>
  
    <h2 id='benchmark' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Benchmark
  
  <a href='blog/logreduce-capn-proto#benchmark' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      In this section, I measure the performance of Cap’n Proto using a sample report of 1k lines with 2k lines of context.
    </p>
  
    <h3 id='cpu-usage' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  CPU usage
  
  <a href='blog/logreduce-capn-proto#cpu-usage' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      Here are the results of the <a href='https://github.com/logreduce/logreduce/blob/main/crates/report/benches/bench-report.rs' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>benchmark</a> running on my thinkpad t14 laptop:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ cargo bench # lower is better
Decoder/capnp           time:   [296.55 µs 297.00 µs 297.45 µs]
Decoder/bincode         time:   [278.36 µs 279.11 µs 280.01 µs]
Decoder/json            time:   [954.06 µs 956.90 µs 961.04 µs]

Encoder/capnp           time:   [71.704 µs 71.773 µs 71.875 µs]
Encoder/bincode         time:   [26.368 µs 26.394 µs 26.425 µs]
Encoder/json            time:   [162.20 µs 162.33 µs 162.46 µs]

Read/capnp              time:   [0.1119 µs 0.1120 µs 0.1129 µs]
Read/bincode            time:   [294.48 µs 295.36 µs 296.59 µs]
Read/json               time:   [987.78 µs 990.39 µs 995.78 µs]</code></pre></div>
    <p class='mb-3'>
      Note that this is a simple benchmark, and I may have missed some optimizations, though the results match the public <a href='https://github.com/djkoloski/rust_serialization_benchmark' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>rust serialization benchmark</a>.
    </p>
  
    <p class='mb-3'>
      The encoder/decoder benchmark loads the full report struct. Cap’n Proto encoder/decoder are a bit slower because they perform extra validation work to protect against malicious input (see <a href='https://capnproto.org/encoding.html#security-considerations' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>security considerations</a>).
    </p>
  
    <p class='mb-3'>
      The read benchmark traverses the report to count the number of lines. In that case, Cap’n Proto is three orders of magnitude faster because we can access the data directly from the reading buffer, without perfoming any copy. This is great for rendering in the browser, because the dom elements need to copy the data anyway, so we can avoid decoding the report into an intermediary structure. Here is how the read benchmark is implemented:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='rust language-rust'>group.bench_function("capnp", |b| b.iter(|| {
    // Create a message reader
    let mut slice: &[u8] = black_box(&amp;encoded_capnp);
    let message_reader = capnp::serialize::read_message_from_flat_slice(
        &amp;mut slice,
        capnp::message::ReaderOptions::new(),
    )
    .unwrap();
    let reader = message_reader
        .get_root::&lt;logreduce_report::schema_capnp::report::Reader&lt;'_&gt;&gt;()
        .unwrap();

    // Traverse the list of log reports
    let count = reader
        .get_log_reports()
        .unwrap()
        .iter()
        .fold(0, |acc, lr| acc + lr.get_anomalies().unwrap().len());
    assert_eq!(count, 1025);
}));

group.bench_function("bincode", |b| b.iter(|| {
    let slice: &[u8] = black_box(&amp;encoded_bincode);
    let report: Report = bincode::deserialize_from(slice).unwrap();
    let count = report
        .log_reports
        .iter()
        .fold(0, |acc, lr| acc + lr.anomalies.len());
    assert_eq!(count, 1025)
}));</code></pre></div>
    <h3 id='report-file-size' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Report file size.
  
  <a href='blog/logreduce-capn-proto#report-file-size' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      Cap’n Proto wire format is a bit heavier and after compression, about 12% bigger than bincode:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ du -b report*
162824	report-capnp.bin
114360	report-capnp-packed.bin
123916	report-bincode.bin
149830	report.json

$ gzip report*; du -b report*
59361	report-capnp.bin.gz
61280	report-capnp-packed.bin.gz
52435	report-bincode.bin.gz
50401	report.json.gz</code></pre></div>
    <p class='mb-3'>
      Note that Cap’n Proto also supports a packed format, but it has higher runtime costs and worse gzip compressions.
    </p>
  
    <p class='mb-3'>
      It is surprising that compression works so well on JSON for this schema. I guess this is because the report is mostly a list of list of text with few structure fields.
    </p>
  
    <h3 id='client-code-size' class='group mt-6 mb-4 font-bold text-gray-700 text-3xl'>
      
  Client code size
  
  <a href='blog/logreduce-capn-proto#client-code-size' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h3>
  
    <p class='mb-3'>
      Lastly the runtime code is similar, here is the WASM size before and after the <a href='https://github.com/logreduce/logreduce/pull/57' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>PR introducing capnp</a>:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='ShellSession language-ShellSession'>$ nix build -o capnp   github:logreduce/logreduce/fb4f69e#web
$ nix build -o bincode github:logreduce/logreduce/2578019#web
$ du -b capnp/*.wasm bincode/*.wasm
529322	capnp/logreduce-web.wasm
531327	bincode/logreduce-web.wasm</code></pre></div>
    <p class='mb-3'>
      I guess the runtime code is smaller because capnp does not use the serde machinery.
    </p>
  
    <h2 id='conclusion' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Conclusion
  
  <a href='blog/logreduce-capn-proto#conclusion' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      Cap’n Proto works well for logreduce. The schema language is simple to understand and the generated code is easy to work with. Being able to read the data directly from memory is a great capability that can enable blazingly fast processing.
    </p>
  
    <p class='mb-3'>
      Writing the encoder and decoder is a bit of fairly mechanical work. However doing this work manually enables adding customization, for example, deduplicating the data using a process known as <a href='https://en.wikipedia.org/wiki/String_interning' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>string interning</a>. Future work in rust introspection may enable deriving this work automatically, checkout the <a href='https://soasis.org/posts/a-mirror-for-rust-a-plan-for-generic-compile-time-introspection-in-rust/' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Shepherd’s Oasis blog post</a> to learn more.
    </p>
  
    <p class='mb-3'>
      In conclusion, replacing bincode with Cap’n Proto future proofs logreduce reports. This format adds some negligible storage and processing costs, in exchange for a backward compatible schema and more efficient data access. Flatbuffers is also worth considering as it has a lower storage cost, but it requires more work to verify that the data is safe to be processed.
    </p>
  
  <!-- What goes in this file will appear below the note body-->
</article>
        </div>
        <div class='hidden md:block md:col-span-2 md:border-l'>
          <nav id='toc' class='hidden leading-relaxed md:block md:sticky md:top-0 md:max-h-screen md:overflow-y-auto'>
  <div class='text-gray-600 text-sm -mt-2'>
    
        <ul class='ml-2'>
          
            <li class='whitespace-nowrap truncate mt-2' title='Context and problem statement'>
              <a href='blog/logreduce-capn-proto#context-and-problem-statement' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Context and problem statement
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Bincode versioning scheme'>
              <a href='blog/logreduce-capn-proto#bincode-versioning-scheme' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Bincode versioning scheme
              </a>
              
        <ul class='ml-2'>
          
            <li class='whitespace-nowrap truncate mt-2' title='Prepare the playground'>
              <a href='blog/logreduce-capn-proto#prepare-the-playground' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Prepare the playground
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Create the initial report'>
              <a href='blog/logreduce-capn-proto#create-the-initial-report' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Create the initial report
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Updating the schema'>
              <a href='blog/logreduce-capn-proto#updating-the-schema' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Updating the schema
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Introducing Cap’n Proto'>
              <a href='blog/logreduce-capn-proto#introducing-capn-proto' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Introducing Cap’n Proto
              </a>
              
        <ul class='ml-2'>
          
            <li class='whitespace-nowrap truncate mt-2' title='Schema Language'>
              <a href='blog/logreduce-capn-proto#schema-language' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Schema Language
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Code generation'>
              <a href='blog/logreduce-capn-proto#code-generation' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Code generation
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Report Encoder/Decoder'>
              <a href='blog/logreduce-capn-proto#report-encoderdecoder' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Report Encoder/Decoder
              </a>
              
        <ul class='ml-2'>
          
            <li class='whitespace-nowrap truncate mt-2' title='Encode a report'>
              <a href='blog/logreduce-capn-proto#encode-a-report' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Encode a report
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Decode a report'>
              <a href='blog/logreduce-capn-proto#decode-a-report' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Decode a report
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Evolving the schema'>
              <a href='blog/logreduce-capn-proto#evolving-the-schema' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Evolving the schema
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Benchmark'>
              <a href='blog/logreduce-capn-proto#benchmark' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Benchmark
              </a>
              
        <ul class='ml-2'>
          
            <li class='whitespace-nowrap truncate mt-2' title='CPU usage'>
              <a href='blog/logreduce-capn-proto#cpu-usage' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                CPU usage
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Report file size.'>
              <a href='blog/logreduce-capn-proto#report-file-size' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Report file size.
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Client code size'>
              <a href='blog/logreduce-capn-proto#client-code-size' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Client code size
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Conclusion'>
              <a href='blog/logreduce-capn-proto#conclusion' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Conclusion
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
        </ul>
      
  </div>
  <script>
    // Highlight the TOC, based from https://stackoverflow.com/a/75346369
    // TODO: We should get rid of JavaScript! See https://github.com/srid/emanote/issues/520
    function highlightTOC() {
      // Grab the toc links
      const links = document.querySelectorAll("ul > li > a.--ema-toc");

      // Find the matching anchors in the document body
      const sections = [];
      links.forEach((link) => {
        let found = {};
        for (section of document.querySelectorAll("a.--ema-anchor")) {
          if (link.href == section.href) {
            found = section;
            break;
          }
        }
        sections.push(found);
      });

      // Current toc link is marked with the following class
      const mark = "toc-item-active";

      // Set window scroll handler to update the toc mark.
      window.onscroll = () => {
        // Remove previous mark
        links.forEach((link) => {
          link.classList.remove(mark);
        });

        // Mark the link of the section that is in view, starting from the end
        let marked = false;
        for (var i = sections.length - 1; i >= 0; i--) {
          if (window.scrollY > sections[i].offsetTop - 80) {
            links[i].classList.add(mark);
            marked = true;
            break;
          }
        }

        // Special case for the first and last section which might not reach the top
        if (!marked && window.scrollY > 0) {
          let i = 0;
          if ((window.innerHeight + Math.round(window.scrollY)) >= document.body.offsetHeight) {
            // We are at the bottom
            i = links.length - 1
          }
          links[i].classList.add(mark);
        }
      };
    }
    highlightTOC();
  </script>
</nav>
        </div>
      </div>
      
    <div class='flex flex-col lg:flex-row lg:space-x-2'>
      
      
    </div>
    
  <section class='flex flex-wrap items-end justify-center my-4 space-x-2 space-y-2 font-mono text-sm'>
    
      <!-- FIXME: The use of -/tags is wrong, because we should use routeUrl using Ema's encoder
        Perhaps Emanote should inject tagMetas with urls.
      -->
      <a title='Tag' class='px-1 bg-gray-100 rounded hover:bg-gray-50 hover:text-blue-500' href='-/tags/blog'>
        <!-- DoNotFormat -->
        #blog
        <!-- DoNotFormat -->
      </a>
    
      <!-- FIXME: The use of -/tags is wrong, because we should use routeUrl using Ema's encoder
        Perhaps Emanote should inject tagMetas with urls.
      -->
      <a title='Tag' class='px-1 bg-gray-100 rounded hover:bg-gray-50 hover:text-blue-500' href='-/tags/rust'>
        <!-- DoNotFormat -->
        #rust
        <!-- DoNotFormat -->
      </a>
    
      <!-- FIXME: The use of -/tags is wrong, because we should use routeUrl using Ema's encoder
        Perhaps Emanote should inject tagMetas with urls.
      -->
      <a title='Tag' class='px-1 bg-gray-100 rounded hover:bg-gray-50 hover:text-blue-500' href='-/tags/logreduce'>
        <!-- DoNotFormat -->
        #logreduce
        <!-- DoNotFormat -->
      </a>
    
  </section>
  <div class='flex items-center justify-center mt-2'>
    <a class='text-gray-300 hover:text-blue-600 text-sm' title='Edit this page on GitHub' href='https://github.com/TristanCacqueray/TristanCacqueray.github.io/edit/main/content/blog/logreduce-capn-proto.md'>
      <svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z'></path>
      </svg>
    </a>
    <p class='text-sm text-gray-600 mx-2'>
      This work is licensed under a <a class='hover:underline' href='http://creativecommons.org/licenses/by/4.0/'>Creative Commons Attribution 4.0 International License</a>
    </p>
  </div>


    <!-- What goes in this file will at the very end of the main div -->
  </main>
</div>
        </div>
      
      <footer class='flex items-center justify-center mt-2 mb-8 space-x-4 text-center text-gray-800'>
  
  <div>
    <a href='' title='Go to Home page'>
      <svg xmlns='http://www.w3.org/2000/svg' class='w-6 h-6 hover:text-blue-700' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'></path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/all' title='View Index'>
      <svg class='w-6 h-6 hover:text-blue-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/tags' title='View tags'>
      <svg class='w-6 h-6 hover:text-blue-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='https://emanote.srid.ca' target='_blank' title='Generated by Emanote 1.3.15.1'>
      <img class='w-6 h-6 hover:text-blue-700' src='_emanote-static/emanote-logo.svg' />
    </a>
  </div>
</footer>

    </div>
  
  <div id='stork-search-container' class='hidden fixed w-screen h-screen inset-0 backdrop-filter backdrop-blur-sm'>
  <div class='fixed w-screen h-screen inset-0' onclick='window.emanote.stork.toggleSearch()'></div>

  <div class='container mx-auto p-10 mt-10'>
    <div class='stork-wrapper-flat container mx-auto'>
      <input id='stork-search-input' data-stork='emanote-search' class='stork-input' placeholder='Search (Ctrl+K) ...' />
      <div data-stork='emanote-search-output' class='stork-output'></div>
    </div>
  </div>
</div>
  
    
  
</body>

</html>

