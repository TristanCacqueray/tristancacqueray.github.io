<!DOCTYPE html>
<!-- DoNotFormat -->
<!-- DoNotFormat -->




<!-- DoNotFormat -->
<!-- DoNotFormat -->

<html lang='en'>

<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>
    Adding Operational Transformation To Butler â€“ Tristan's Zettelkasten
  </title>
  
    
      <meta property='og:description' content='Butler is a web-based multiplayer virtual operating system that features collaborative applications. This post shows how I integrated Operational Transformation (OT) to enable users to simultaneously edit a text document in Butler.' />
      <meta property='og:site_name' content="Tristan's Zettelkasten" />
      <meta property='og:image' content='https://midirus.com/blog/media/ot-wiki.png' />
      <meta property='og:type' content='website' />
      <meta property='og:title' content='Adding Operational Transformation To Butler' />
      
        <meta name='twitter:card' content='summary_large_image' />
      
    
    
      <base href='/' />
      <link href='/static/favicon.jpeg' rel='icon' />
    
    <!-- highlight.js -->
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/hybrid.min.css' />
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js'></script>
<!-- Include languages that Emanote itself uses -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/haskell.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/nix.min.js'></script>
<script>hljs.highlightAll();</script>



<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/lisp.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/scheme.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/glsl.min.js'></script>

<script src='/static/godiag.js'></script>
<style>
.kbd {
    display: inline-block;
    padding: 0.25rem;
    font: 11px mono;
    line-height: 10px;
    color: #1f2328;
    vertical-align: middle;
    background-color: rgb(246, 248, 250);
    border: solid 1px #1f232826;
    border-bottom-color: rgba(209, 217, 224, 0.7);
    border-radius: 6px;
    box-shadow: inset 0 -1px 0 #d1d9e0b3;
  }
}
code.baduk {
  background-color: white;
  color: black;
}
</style>
<!-- mermaid.js --><script type='module'>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.init(undefined,document.querySelectorAll(".mermaid"));
</script>

<script>
window.MathJax = {
  startup: {
    ready: () => {MathJax.startup.defaultReady();}
  }
};
</script>
<script async id='MathJax-script' src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script>

  
  
  <link href='tailwind.css?instanceId=3b96e0e2-e324-442b-ac4d-2bce3635398b' rel='stylesheet' type='text/css' />

  <style>
    /* Heist error element */
    strong.error {
      color: lightcoral;
      font-size: 90%;
      font-family: monospace;
    }

    /* Callouts */
    div.callout {
      background-color: #f5f5f5;
      padding: 1em 1em 0.5em;
      border-radius: 0.5em;
      margin-bottom: 1em;
    }

    .callout[data-callout="note"] {
      --callout-color: 8, 109, 221;
    }

    .callout[data-callout="info"] {
      --callout-color: 8, 109, 221;
    }

    .callout[data-callout="tip"] {
      --callout-color: 8, 191, 188;
    }

    .callout[data-callout="warning"] {
      --callout-color: 236, 117, 0;
    }

    .callout[data-callout="failure"] {
      --callout-color: 233, 49, 71;
    }

    div.callout {
      background-color: rgba(var(--callout-color), 0.1);
    }

    .callout .callout-title {
      color: rgb(var(--callout-color));
    }

    div.callout-title {
      display: flex;
      align-items: center;
      margin-bottom: 0.5em;
      font-variation-settings: 'wght' 600;
    }

    div.callout-title div.callout-title-inner {
      margin-left: 0.5em;
    }

    a.--ema-toc:not(.toc-item-active) {
      background-color: #ffffff !important;
    }

    /* External link icon */
    a[data-linkicon=""]::after {
      content: ""
    }

    /* missing from tailwind generated css */
    .min-h-5 {
      min-height: 1.25rem;
    }

    a[data-linkicon=none]::after {
      content: ""
    }

    a[data-linkicon="external"] {
      padding-right: 24px;
    }
    a[data-linkicon="external"]::after {
      margin-right: -24px;
      content: url('data:image/svg+xml,\
      <svg xmlns="http://www.w3.org/2000/svg" height="0.7em" viewBox="0 0 20 20"> \
        <g style="stroke:gray;stroke-width:1"> \
          <line x1="5" y1="5" x2="5" y2="14" /> \
          <line x1="14" y1="9" x2="14" y2="14" /> \
          <line x1="5" y1="14" x2="14" y2="14" /> \
          <line x1="5" y1="5" x2="9" y2="5"  /> \
          <line x1="10" y1="2" x2="17" y2="2"  /> \
          <line x1="17" y1="2" x2="17" y2="9" /> \
          <line x1="10" y1="9" x2="17" y2="2" style="stroke-width:1.0" /> \
        </g> \
      </svg>');
    }

    a[data-linkicon="external"][href^="mailto:"]::after {
      content: url('data:image/svg+xml,\
        <svg \
          xmlns="http://www.w3.org/2000/svg" \
          height="0.7em" \
          fill="none" \
          viewBox="0 0 24 24" \
          stroke="gray" \
          stroke-width="2"> \
          <path \
            stroke-linecap="round" \
            stroke-linejoin="round" \
            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /> \
        </svg>');
    }
  </style>
  <!-- What goes in this file will appear on near the end of <head>--><link rel='preload' href='_emanote-static/fonts/Work_Sans/WorkSans-VariableFont_wght.ttf' as='font' type='font/ttf' crossorigin />

<style>
  @font-face {
    font-family: 'WorkSans';
    /* FIXME: This ought to be: ${ema:emanoteStaticLayerUrl}/fonts/Work_Sans/WorkSans-VariableFont_wght.ttf */
    src: url(_emanote-static/fonts/Work_Sans/WorkSans-VariableFont_wght.ttf) format("truetype");
    font-display: swap;
  }

  body {
    font-family: 'WorkSans', sans-serif;
    font-variation-settings: 'wght' 350;
  }

  a.mavenLinkBold {
    font-variation-settings: 'wght' 400;
  }

  strong {
    font-variation-settings: 'wght' 500;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  header,
  .header-font {
    font-family: 'WorkSans', sans-serif;
  }

  h1 {
    font-variation-settings: 'wght' 500;
  }

  h2 {
    font-variation-settings: 'wght' 400;
  }

  h3 {
    font-variation-settings: 'wght' 300;
  }
</style>


  
    <style>
      /* For use in sidebar.tpl, as we cannot achieve this in tailwind itself! */
      /* md:min-w-48  */
      @media (min-width: 768px) {
        #sidebar {
          min-width: 12rem;
        }
      }

      /* xl:min-w-64  */
      @media (min-width: 1280px) {
        #sidebar {
          min-width: 16rem;
        }
      }
    </style>

    
      <link rel='stylesheet' href='_emanote-static/inverted-tree.css' />
    
  
  <link rel='stylesheet' href='_emanote-static/stork/flat.css' />
<!-- Custom Stork-search styling for Emanote -->
<style>
  #stork-search-container {
    z-index: 1000;
    background-color: rgb(15 23 42/.8);
  }

  .stork-overflow-hidden-important {
    overflow: hidden !important;
  }
</style>


<script src='_emanote-static/stork/stork.js'></script>

  
    <script id='emanote-stork' data-emanote-base-url='/'>
      window.emanote = {};
      window.emanote.stork = {
        searchShown: false,
        indexIsStale: false,
        toggleSearch: function () {
          window.emanote.stork.refreshIndex();
          document.getElementById('stork-search-container').classList.toggle('hidden');
          window.emanote.stork.searchShown = document.body.classList.toggle('stork-overflow-hidden-important');
          if (window.emanote.stork.searchShown) {
            document.getElementById('stork-search-input').focus();
          }
        },
        clearSearch: function () {
          document.getElementById('stork-search-container').classList.add('hidden');
          document.body.classList.remove('stork-overflow-hidden-important');
          window.emanote.stork.searchShown = false;
        },

        getBaseUrl: function () {
          const baseUrl = document.getElementById("emanote-stork").getAttribute('data-emanote-base-url') || '/';
          return baseUrl;
        },

        registerIndex: function (options) {
          const indexName = 'emanote-search'; // used to match input[data-stork] attribute value
          const indexUrl = window.emanote.stork.getBaseUrl() + '-/stork.st';
          stork.register(
            indexName,
            indexUrl,
            options);
        },

        init: function () {
          if (document.readyState !== 'complete') {
            window.addEventListener('load', function () {
              stork.initialize(window.emanote.stork.getBaseUrl() + '_emanote-static/stork/stork.wasm');
              window.emanote.stork.registerIndex();
            });

            document.addEventListener('keydown', event => {
              if (window.emanote.stork.searchShown && event.key === 'Escape') {
                window.emanote.stork.clearSearch();
                event.preventDefault();
              } else if ((event.key == 'k' || event.key == 'K') && (event.ctrlKey || event.metaKey)) {
                window.emanote.stork.toggleSearch();
                event.preventDefault();
              }
            });
          } else {
            // This section is called during Ema's hot reload.
            // 
            // Mark the current index as stale, and refresh it *only when* the
            // user actually invokes search.
            // 
            // We do not refresh the index *right away*, as that will cause
            // memory leaks in the browser. See
            // https://github.com/srid/emanote/issues/411#issuecomment-1402056235
            console.log("stork: Marking index as stale");
            window.emanote.stork.markIndexAsStale();
          }
        },

        markIndexAsStale: function () {
          window.emanote.stork.indexIsStale = true;
        },

        refreshIndex: function () {
          if (window.emanote.stork.indexIsStale) {
            console.log("stork: Reloading index");
            window.emanote.stork.indexIsStale = false;
            // NOTE: This will leak memory. See the comment above.
            window.emanote.stork.registerIndex({ forceOverwrite: true });
          }
        }

      };

      window.emanote.stork.init();
    </script>
  

</head>

<!-- DoNotFormat -->



<!-- DoNotFormat -->

<body class='bg-gray-400 overflow-y-scroll'>
  
    <div class='lg:container mx-auto mt-2 md:mt-4  '>
      
        <!-- DoNotFormat -->
<!-- DoNotFormat -->

<nav id='uptree' class='flipped tree' style='transform-origin: 50%;'>
  <ul class='root'>
    <li>
      
        <ul>
          
            <li>

  <a href='project/butler'>
    <div class='text-gray-900 hover:bg-blue-500 hover:text-white cursor-pointer forest-link'>
      ButlerOS
    </div>
  </a>

  
    <ul>
      
        <li>

  <a href='project'>
    <div class='text-gray-900 hover:bg-blue-500 hover:text-white cursor-pointer forest-link'>
      Projects
    </div>
  </a>

  
    <ul>
      
        <li>

  <a href=''>
    <div class='text-gray-900 hover:bg-blue-500 hover:text-white cursor-pointer forest-link'>
      Tristan de Cacqueray
    </div>
  </a>

  
</li>
      
    </ul>
  
</li>
      
    </ul>
  
</li>
          
            <li>

  <a href='blog'>
    <div class='text-gray-900 hover:bg-blue-500 hover:text-white cursor-pointer forest-link'>
      Blog
    </div>
  </a>

  
</li>
          
        </ul>
      
    </li>
  </ul>
</nav>
      

      

      
        <div id='container' class='relative md:shadow-2xl md:mb-8'>
          
  <div class='absolute -top-6 right-1 md:right-0 flex flex-row items-center justify-center'>
    <a title='Search (Ctrl+K)' class='cursor-pointer' onclick='window.emanote.stork.toggleSearch()'>
      <svg xmlns='http://www.w3.org/2000/svg' style='width: 1rem;' class='hover:text-blue-700' f
 fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'>
  <path stroke-linecap='round' stroke-linejoin='round' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'></path>
</svg>
    </a>
  </div>

          <!-- Main body column -->
          <div class='flex-1 w-full bg-white'>
  <main class='px-4 py-4'>
    <h1 id='ema-title' class='flex items-end justify-center mb-4 p-3 bg-blue-100 text-5xl font-extrabold text-black rounded'>
  <a class='z-40 tracking-tighter '>
    Adding Operational Transformation To Butler
  </a>
</h1>

  <span class='text-sm text-right font-mono text-gray-600 block -mt-9 rounded px-1 mb-7 min-h-5'>
    2024-07-30
  </span>


    
      <div class='md:grid md:gap-4 md:grid-cols-8'>
        <div class='md:col-span-6'>
          <article class='overflow-auto'>
  <!-- What goes in this file will appear on top of note body-->
  






    <p class='mb-3'>
      <a href='https://github.com/ButlerOS/haskell-butler' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Butler</a> is a web-based multiplayer virtual operating system that features collaborative applications. This post shows how I integrated Operational Transformation (OT) to enable users to simultaneously edit a text document in Butler.
    </p>
  
    <p class='mb-3'>
      In three parts, I present:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          The flaw in my initial implementation.
        </li>
      
        <li>
          How to use the <a href='https://github.com/Operational-Transformation/ot.hs' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>ot.hs</a> library.
        </li>
      
        <li>
          An integration with the <a href='https://quilljs.com/' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>quill</a> editor.
        </li>
      
    </ul>
  <div class='flex items-center justify-center'><img class='inline mb-3' src='blog/media/ot-wiki.png' alt='logo' style='width: inherit;' /></div>
    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      Image by <a href='https://commons.wikimedia.org/w/index.php?curid=7123571' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Nusnus - Own work, CC BY-SA 3.0</a>
    </p>
  
    </blockquote>
  
    <h2 id='context-and-problem-statement' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Context and problem statement
  
  <a href='blog/butler-ot#context-and-problem-statement' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      Butlerâ€™s text editor, Noter, is the default document editing application. Each user has their own cursor, and can simultaneously update the document. The initial implementation simply broadcasted the usersâ€™ events without considering potential conflicts.
    </p>
  
    <p class='mb-3'>
      The events were composed of a line and column position along with an insert or delete operation. This worked well, as long as concurrent edits happened on different lines, and no lines were added nor removed above another cursor.
    </p>
  
    <p class='mb-3'>
      Unfortunately, as demonstrated by the following scenario, there was a risk of desynchronization:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='mermaid language-mermaid'>sequenceDiagram
    actor Alice
    participant Server
    actor Bob

    activate Alice
    Note left of Alice: first
    Alice-&gt;&gt;Server: Insert "first" at line 1
    deactivate Alice
    Note over Server: first

    Server-&gt;&gt;Bob  : Insert "first" at line 1
    Note right of Bob: first

    par Acceptable Concurrent Edits
        activate Bob
        Note right of Bob: first&lt;br /&gt;second
        Bob-&gt;&gt;Server  : Insert "second" at line 2
        deactivate Bob
        Note over Server: first&lt;br /&gt;second

        activate Alice
        Note left of Alice: first item
        Alice-&gt;&gt;Server: Insert "item" at line 1
        deactivate Alice
        Note over Server: first item&lt;br /&gt;second

        Server-&gt;&gt;Alice: Insert "second" at line 2
        Server-&gt;&gt;Bob:   Insert "item" at line 1
        Note left of Alice: first item&lt;br /&gt;second
        Note right of Bob: first item&lt;br /&gt;second
    end

    critical Broken Edits
        activate Alice
        Note left of Alice: first item&lt;br /&gt;new line&lt;br /&gt;second
        Alice-&gt;&gt;Server: Insert "\nnew line" at line 1
        deactivate Alice
        Note over Server: first item&lt;br /&gt;new line&lt;br /&gt;second

        activate Bob
        Note right of Bob: first item&lt;br /&gt;second item
        Bob-&gt;&gt;Server  : Insert "item" at line 2
        deactivate Bob
        Note over Server: first item&lt;br /&gt;new line item&lt;br /&gt;second

        Server-&gt;&gt;Bob: Insert "\nnew line" at line 1
        Server-&gt;&gt;Alice: Insert "item" at line 2
        Note left of Alice: first item&lt;br /&gt;new line item&lt;br /&gt;second
        Note right of Bob: first item&lt;br /&gt;new line&lt;br /&gt;second item
    end</code></pre></div>
    <p class='mb-3'>
      In this case, the last edits from Bob happened at the wrong line, and the documents are no longer synchronized. I tried to manually take into account the previous events, before quickly realizing that this is a hard problem with many edge cases. Fortunately, I discovered the OT algorithm which nicely solves this issue.
    </p>
  
    <h2 id='ot-with-haskell' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  OT with Haskell
  
  <a href='blog/butler-ot#ot-with-haskell' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      OTâ€™s core idea is to transform and compose operations to maintain the document consistency. Tim Baumann, the creator of the Operational-Transformation GitHub group implemented OT with Haskell.
    </p>
  
    <p class='mb-3'>
      The API defines a text operation with a list of actions:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>newtype Operation = Operation [Action]
data Action = Retain Int | Insert Text | Delete Int</code></pre></div>
    <p class='mb-3'>
      To perform the transformations, the API features the following functions to manage the server and clients states:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>-- | Text editor produces a new operation.
-- Return wheter to send the operation to the server.
applyClient :: ClientState -&gt; Operation -&gt; (Bool, ClientState)

-- | Server receives the operation.
-- Return the operation to be broadcasted to all clients.
applyOperation :: ServerState -&gt; Revision -&gt; Operation -&gt; (Operation, ServerState)

-- | Emiting editor acknowledge the edit.
-- Return an optional operation that must be sent to the server.
serverAck :: ClientState -&gt; Maybe (Maybe Operation, ClientState)

-- | Other editors receive the server operation.
-- Return the transformed operation that must be applied to the local doc.
applyServer :: ClientState -&gt; Operation -&gt; (Operation, ClientState)</code></pre></div>
    <p class='mb-3'>
      The state can be created with the <code class='py-0.5 px-0.5 bg-gray-100'>initialState</code> helpers, and the revision is just a number that the client must increment each time it receives a server event. Thatâ€™s all it takes to integrate OT with Haskell.
    </p>
  
    <p class='mb-3'>
      For the end-user text edition, I found the <a href='https://quilljs.com/' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>quill</a> project which conveniently provides text change events as delta objects that are suitable for OT. So I put together a simple demo in this <a href='https://github.com/TristanCacqueray/haskell-xstatic/commit/204fbda0aeb36a26b518ea418516efd55d0a1b40' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>commit</a>. Unfortunately, it didnâ€™t work well because the <code class='py-0.5 px-0.5 bg-gray-100'>ClientState</code> canâ€™t be managed on the server side. I tried to fiddle with the web-socket protocol to roundtrip the events and ensure consistency, but this became unusable on high latency connections.
    </p>
  
    <p class='mb-3'>
      Thankfully, Tim also implemented OT with JavaScript, as well as a formalization in Coq. The next section explains my final implementation.
    </p>
  
    <h2 id='integration-with-quill' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Integration with Quill
  
  <a href='blog/butler-ot#integration-with-quill' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      To make this work, the server must only be in charge of applying operations and broadcasting the events to the connected clients. Therefore, it is necessary to perform client transformations in the userâ€™s browser so that the client state is synchronized with their local document.
    </p>
  
    <p class='mb-3'>
      Here is the final architecture I used:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='mermaid language-mermaid'>flowchart LR
    subgraph Haskell Server
      SW[Servant WebSocket] --&gt; S[ot.hs applyOperation]
    end
    subgraph JavaScript Client 2
      AS[ot.js applyServer] --&gt; Q2[Quill]
      S --&gt; AS
    end
    subgraph JavaScript Client 1
      Q1[Quill] --&gt; AC[ot.js applyClient]
      SA[ot.js serverAck] --&gt; SW
      AC --&gt; SW
      S --&gt; SA
    end</code></pre></div>
    <p class='mb-3'>
      The <a href='https://github.com/Operational-Transformation/ot.js' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>ot.js</a> uses the same API so it was easy to integrate. The first step is to initialize the state and setups the callbacks:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='javascript language-javascript'>// Local client state (from ot.js)
const client = new ot.Client(0)

// How to send operation to the server
client.sendOperation = (rev, op) =&gt; {
  webSocket.send(JSON.stringify([rev, op]))
}

// How to apply operation to the local document
client.applyOperation = (op) =&gt; {
  quill.updateContents({ops: op.ops.map(decodeDelta)}, "api")
}</code></pre></div>
    <p class='mb-3'>
      Here is the web-socket connection to the central server:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='javascript language-javascript'>const webSocket = new WebSocket("ws://" + window.location.host + "/ws");
webSocket.onmessage = (event) =&gt; {
  const op = JSON.parse(event.data)
  if (op === null) {
    client.serverAck()
  } else {
    // Update the local state with server operation
    client.applyServer(ot.TextOperation.fromJSON(op))
  }
}</code></pre></div>
    <p class='mb-3'>
      Finally, the quill editor is configured like this:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='javascript language-javascript'>const quill = new Quill('#editor')
quill.on('text-change', (delta, oldDelta, source) =&gt; {
  if (source === "user") {
    const op = ot.TextOperation.fromJSON(delta.ops.map(encodeDelta))
    // Update the local state with local operation
    client.applyClient(op)
  }
})</code></pre></div>
    <p class='mb-3'>
      Checkout the <a href='https://github.com/TristanCacqueray/haskell-xstatic/blob/main/demo-quill-ot/Server.hs' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Server.hs</a> module to see the full implementation. Note that this version is completely standalone, and it also implements usersâ€™ selection with <a href='https://www.npmjs.com/package/quill-cursors' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>quill-cursors</a>.
    </p>
  
    <h2 id='conclusion' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Conclusion
  
  <a href='blog/butler-ot#conclusion' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      My initial text editor implementation had a serious flaw when multiple users simultaneously edited a document resulted in desynchronization. Fortunately, this is a known problem that can be solved with operational transformation (OT), and I found a suitable server and client implementation that works well inside <a href='project/butler' class='text-blue-600 mavenLinkBold hover:underline' data-wikilink-type='WikiLinkTag'>ButlerOS</a> architecture.
    </p>
  
    <p class='mb-3'>
      The Haskell version helped me figure out how to use OT and I found that the code was well thought out, with many property tests. The author also wrote a <a href='https://github.com/Operational-Transformation/ot.v' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>formalization in Coq</a>, a theorem prover, to provide a formal proof that the algorithm is sound.
    </p>
  
    <p class='mb-3'>
      My integration seems to work well, and Iâ€™m looking forward to adding new features, such as supporting rich text and providing a revision system. Thanks for your time!
    </p>
  
  <!-- What goes in this file will appear below the note body-->
</article>
        </div>
        <div class='hidden md:block md:col-span-2 md:border-l'>
          <nav id='toc' class='hidden leading-relaxed md:block md:sticky md:top-0 md:max-h-screen md:overflow-y-auto'>
  <div class='text-gray-600 text-sm'>
    <a class='ml-1 cursor-pointer p-0.5' title='Title' id='--ema-title-toc'>Title</a>
    
        <ul class='ml-2'>
          
            <li class='whitespace-nowrap truncate mt-2' title='Context and problem statement'>
              <a href='blog/butler-ot#context-and-problem-statement' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Context and problem statement
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='OT with Haskell'>
              <a href='blog/butler-ot#ot-with-haskell' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                OT with Haskell
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Integration with Quill'>
              <a href='blog/butler-ot#integration-with-quill' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Integration with Quill
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Conclusion'>
              <a href='blog/butler-ot#conclusion' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Conclusion
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
        </ul>
      
  </div>
  <script>
    // Highlight the TOC, based from https://stackoverflow.com/a/75346369
    // TODO: We should get rid of JavaScript! See https://github.com/srid/emanote/issues/520
    function highlightTOC() {
      // Setup title link
      const titleToc = document.querySelectorAll("nav > div > a#--ema-title-toc");
      if (titleToc.length) {
        titleToc[0].onclick = () => {
          document.querySelectorAll("h1#ema-title")[0].scrollIntoView({ behavior: "smooth"});
          history.pushState("", document.title, window.location.pathname + window.location.search);
        }
      }
      // Grab the toc links
      const links = document.querySelectorAll("ul > li > a.--ema-toc");

      // Find the matching anchors in the document body
      const sections = [];
      links.forEach((link) => {
        let found = {};
        for (section of document.querySelectorAll("a.--ema-anchor")) {
          if (link.href == section.href) {
            found = section;
            break;
          }
        }
        sections.push(found);
      });

      // Current toc link is marked with the following class
      const mark = "toc-item-active";

      // Set window scroll handler to update the toc mark.
      window.onscroll = () => {
        // Remove previous mark
        links.forEach((link) => {
          link.classList.remove(mark);
        });

        // Mark the link of the section that is in view, starting from the end
        let marked = false;
        for (var i = sections.length - 1; i >= 0; i--) {
          if (window.scrollY > sections[i].offsetTop - 20) {
            links[i].classList.add(mark);
            marked = true;
            break;
          }
        }

        // Special case for the first and last section which might not reach the top
        if (!marked && window.scrollY > 0) {
          let i = 0;
          if ((window.innerHeight + Math.round(window.scrollY)) >= document.body.offsetHeight) {
            // We are at the bottom
            i = links.length - 1
          }
          links[i].classList.add(mark);
        }
      };
    }
    highlightTOC();
  </script>
</nav>

        </div>
      </div>
      
    <div class='flex flex-col lg:flex-row lg:space-x-2'>
      
      
    </div>
    
  <section class='flex flex-wrap items-end justify-center my-4 space-x-2 space-y-2 font-mono text-sm'>
    
      <!-- FIXME: The use of -/tags is wrong, because we should use routeUrl using Ema's encoder
        Perhaps Emanote should inject tagMetas with urls.
      -->
      <a title='Tag' class='px-1 bg-gray-100 rounded hover:bg-gray-50 hover:text-blue-500' href='-/tags/haskell'>
        <!-- DoNotFormat -->
        #haskell
        <!-- DoNotFormat -->
      </a>
    
      <!-- FIXME: The use of -/tags is wrong, because we should use routeUrl using Ema's encoder
        Perhaps Emanote should inject tagMetas with urls.
      -->
      <a title='Tag' class='px-1 bg-gray-100 rounded hover:bg-gray-50 hover:text-blue-500' href='-/tags/ot'>
        <!-- DoNotFormat -->
        #ot
        <!-- DoNotFormat -->
      </a>
    
  </section>
  <div class='flex items-center justify-center mt-2'>
    <a class='text-gray-300 hover:text-blue-600 text-sm' title='Edit this page on GitHub' href='https://github.com/TristanCacqueray/TristanCacqueray.github.io/edit/main/content/blog/butler-ot.md'>
      <svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z'></path>
      </svg>
    </a>
    <p class='text-sm text-gray-600 mx-2'>
      This work is licensed under a <a class='hover:underline' href='http://creativecommons.org/licenses/by/4.0/'>Creative Commons Attribution 4.0 International License</a>
    </p>
  </div>


    <!-- What goes in this file will at the very end of the main div -->
  </main>
</div>
        </div>
      
      <footer class='flex items-center justify-center mt-2 mb-8 space-x-4 text-center text-gray-800'>
  
  <div>
    <a href='' title='Go to Home page'>
      <svg xmlns='http://www.w3.org/2000/svg' class='w-6 h-6 hover:text-blue-700' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'></path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/all' title='View Index'>
      <svg class='w-6 h-6 hover:text-blue-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/tags' title='View tags'>
      <svg class='w-6 h-6 hover:text-blue-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='https://emanote.srid.ca' target='_blank' title='Generated by Emanote 1.3.17.1'>
      <img class='w-6 h-6 hover:text-blue-700' src='_emanote-static/emanote-logo.svg' />
    </a>
  </div>
</footer>

    </div>
  
  <div id='stork-search-container' class='hidden fixed w-screen h-screen inset-0 backdrop-filter backdrop-blur-sm'>
  <div class='fixed w-screen h-screen inset-0' onclick='window.emanote.stork.toggleSearch()'></div>

  <div class='container mx-auto p-10 mt-10'>
    <div class='stork-wrapper-flat container mx-auto'>
      <input id='stork-search-input' data-stork='emanote-search' class='stork-input' placeholder='Search (Ctrl+K) ...' />
      <div data-stork='emanote-search-output' class='stork-output'></div>
    </div>
  </div>
</div>
  
    
  
</body>

</html>

