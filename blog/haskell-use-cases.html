<!DOCTYPE html>
<!-- DoNotFormat -->
<!-- DoNotFormat -->




<!-- DoNotFormat -->
<!-- DoNotFormat -->

<html lang='en'>

<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>
    Haskell use cases for ChangeMetrics â€“ Tristan's Zettelkasten
  </title>
  
    
      <meta property='og:description' content='This post was initially published on the Software Factory blog: https://www.softwarefactory-project.io/practical-haskell-use-cases.html' />
      <meta property='og:site_name' content="Tristan's Zettelkasten" />
      <meta property='og:image' content='https://midirus.com/' />
      <meta property='og:type' content='website' />
      <meta property='og:title' content='Haskell use cases for ChangeMetrics' />
      
        <meta name='twitter:card' content='summary_large_image' />
      
    
    
      <base href='/' />
      <link href='/static/favicon.jpeg' rel='icon' />
    
    <!-- highlight.js -->
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/hybrid.min.css' />
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js'></script>
<!-- Include languages that Emanote itself uses -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/haskell.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/nix.min.js'></script>
<script>hljs.highlightAll();</script>



<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/lisp.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/scheme.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/glsl.min.js'></script>

<script src='/static/godiag.js'></script>
<style>
.kbd {
    display: inline-block;
    padding: 0.25rem;
    font: 11px mono;
    line-height: 10px;
    color: #1f2328;
    vertical-align: middle;
    background-color: rgb(246, 248, 250);
    border: solid 1px #1f232826;
    border-bottom-color: rgba(209, 217, 224, 0.7);
    border-radius: 6px;
    box-shadow: inset 0 -1px 0 #d1d9e0b3;
  }
}
code.baduk {
  background-color: white;
  color: black;
}
</style>
<!-- mermaid.js --><script type='module'>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });
  mermaid.init(undefined,document.querySelectorAll(".mermaid"));
</script>

<script>
window.MathJax = {
  startup: {
    ready: () => {MathJax.startup.defaultReady();}
  }
};
</script>
<script async id='MathJax-script' src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'></script>

  
  
  <link href='tailwind.css?instanceId=3b96e0e2-e324-442b-ac4d-2bce3635398b' rel='stylesheet' type='text/css' />

  <style>
    /* Heist error element */
    strong.error {
      color: lightcoral;
      font-size: 90%;
      font-family: monospace;
    }

    /* Callouts */
    div.callout {
      background-color: #f5f5f5;
      padding: 1em 1em 0.5em;
      border-radius: 0.5em;
      margin-bottom: 1em;
    }

    .callout[data-callout="note"] {
      --callout-color: 8, 109, 221;
    }

    .callout[data-callout="info"] {
      --callout-color: 8, 109, 221;
    }

    .callout[data-callout="tip"] {
      --callout-color: 8, 191, 188;
    }

    .callout[data-callout="warning"] {
      --callout-color: 236, 117, 0;
    }

    .callout[data-callout="failure"] {
      --callout-color: 233, 49, 71;
    }

    div.callout {
      background-color: rgba(var(--callout-color), 0.1);
    }

    .callout .callout-title {
      color: rgb(var(--callout-color));
    }

    div.callout-title {
      display: flex;
      align-items: center;
      margin-bottom: 0.5em;
      font-variation-settings: 'wght' 600;
    }

    div.callout-title div.callout-title-inner {
      margin-left: 0.5em;
    }

    a.--ema-toc:not(.toc-item-active) {
      background-color: #ffffff !important;
    }

    /* External link icon */
    a[data-linkicon=""]::after {
      content: ""
    }

    /* missing from tailwind generated css */
    .min-h-5 {
      min-height: 1.25rem;
    }

    a[data-linkicon=none]::after {
      content: ""
    }

    a[data-linkicon="external"] {
      padding-right: 24px;
    }
    a[data-linkicon="external"]::after {
      margin-right: -24px;
      content: url('data:image/svg+xml,\
      <svg xmlns="http://www.w3.org/2000/svg" height="0.7em" viewBox="0 0 20 20"> \
        <g style="stroke:gray;stroke-width:1"> \
          <line x1="5" y1="5" x2="5" y2="14" /> \
          <line x1="14" y1="9" x2="14" y2="14" /> \
          <line x1="5" y1="14" x2="14" y2="14" /> \
          <line x1="5" y1="5" x2="9" y2="5"  /> \
          <line x1="10" y1="2" x2="17" y2="2"  /> \
          <line x1="17" y1="2" x2="17" y2="9" /> \
          <line x1="10" y1="9" x2="17" y2="2" style="stroke-width:1.0" /> \
        </g> \
      </svg>');
    }

    a[data-linkicon="external"][href^="mailto:"]::after {
      content: url('data:image/svg+xml,\
        <svg \
          xmlns="http://www.w3.org/2000/svg" \
          height="0.7em" \
          fill="none" \
          viewBox="0 0 24 24" \
          stroke="gray" \
          stroke-width="2"> \
          <path \
            stroke-linecap="round" \
            stroke-linejoin="round" \
            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /> \
        </svg>');
    }
  </style>
  <!-- What goes in this file will appear on near the end of <head>--><link rel='preload' href='_emanote-static/fonts/Work_Sans/WorkSans-VariableFont_wght.ttf' as='font' type='font/ttf' crossorigin />

<style>
  @font-face {
    font-family: 'WorkSans';
    /* FIXME: This ought to be: ${ema:emanoteStaticLayerUrl}/fonts/Work_Sans/WorkSans-VariableFont_wght.ttf */
    src: url(_emanote-static/fonts/Work_Sans/WorkSans-VariableFont_wght.ttf) format("truetype");
    font-display: swap;
  }

  body {
    font-family: 'WorkSans', sans-serif;
    font-variation-settings: 'wght' 350;
  }

  a.mavenLinkBold {
    font-variation-settings: 'wght' 400;
  }

  strong {
    font-variation-settings: 'wght' 500;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  header,
  .header-font {
    font-family: 'WorkSans', sans-serif;
  }

  h1 {
    font-variation-settings: 'wght' 500;
  }

  h2 {
    font-variation-settings: 'wght' 400;
  }

  h3 {
    font-variation-settings: 'wght' 300;
  }
</style>


  
    <style>
      /* For use in sidebar.tpl, as we cannot achieve this in tailwind itself! */
      /* md:min-w-48  */
      @media (min-width: 768px) {
        #sidebar {
          min-width: 12rem;
        }
      }

      /* xl:min-w-64  */
      @media (min-width: 1280px) {
        #sidebar {
          min-width: 16rem;
        }
      }
    </style>

    
      <link rel='stylesheet' href='_emanote-static/inverted-tree.css' />
    
  
  <link rel='stylesheet' href='_emanote-static/stork/flat.css' />
<!-- Custom Stork-search styling for Emanote -->
<style>
  #stork-search-container {
    z-index: 1000;
    background-color: rgb(15 23 42/.8);
  }

  .stork-overflow-hidden-important {
    overflow: hidden !important;
  }
</style>


<script src='_emanote-static/stork/stork.js'></script>

  
    <script id='emanote-stork' data-emanote-base-url='/'>
      window.emanote = {};
      window.emanote.stork = {
        searchShown: false,
        indexIsStale: false,
        toggleSearch: function () {
          window.emanote.stork.refreshIndex();
          document.getElementById('stork-search-container').classList.toggle('hidden');
          window.emanote.stork.searchShown = document.body.classList.toggle('stork-overflow-hidden-important');
          if (window.emanote.stork.searchShown) {
            document.getElementById('stork-search-input').focus();
          }
        },
        clearSearch: function () {
          document.getElementById('stork-search-container').classList.add('hidden');
          document.body.classList.remove('stork-overflow-hidden-important');
          window.emanote.stork.searchShown = false;
        },

        getBaseUrl: function () {
          const baseUrl = document.getElementById("emanote-stork").getAttribute('data-emanote-base-url') || '/';
          return baseUrl;
        },

        registerIndex: function (options) {
          const indexName = 'emanote-search'; // used to match input[data-stork] attribute value
          const indexUrl = window.emanote.stork.getBaseUrl() + '-/stork.st';
          stork.register(
            indexName,
            indexUrl,
            options);
        },

        init: function () {
          if (document.readyState !== 'complete') {
            window.addEventListener('load', function () {
              stork.initialize(window.emanote.stork.getBaseUrl() + '_emanote-static/stork/stork.wasm');
              window.emanote.stork.registerIndex();
            });

            document.addEventListener('keydown', event => {
              if (window.emanote.stork.searchShown && event.key === 'Escape') {
                window.emanote.stork.clearSearch();
                event.preventDefault();
              } else if ((event.key == 'k' || event.key == 'K') && (event.ctrlKey || event.metaKey)) {
                window.emanote.stork.toggleSearch();
                event.preventDefault();
              }
            });
          } else {
            // This section is called during Ema's hot reload.
            // 
            // Mark the current index as stale, and refresh it *only when* the
            // user actually invokes search.
            // 
            // We do not refresh the index *right away*, as that will cause
            // memory leaks in the browser. See
            // https://github.com/srid/emanote/issues/411#issuecomment-1402056235
            console.log("stork: Marking index as stale");
            window.emanote.stork.markIndexAsStale();
          }
        },

        markIndexAsStale: function () {
          window.emanote.stork.indexIsStale = true;
        },

        refreshIndex: function () {
          if (window.emanote.stork.indexIsStale) {
            console.log("stork: Reloading index");
            window.emanote.stork.indexIsStale = false;
            // NOTE: This will leak memory. See the comment above.
            window.emanote.stork.registerIndex({ forceOverwrite: true });
          }
        }

      };

      window.emanote.stork.init();
    </script>
  

</head>

<!-- DoNotFormat -->



<!-- DoNotFormat -->

<body class='bg-gray-400 overflow-y-scroll'>
  
    <div class='lg:container mx-auto mt-2 md:mt-4  '>
      
        <!-- DoNotFormat -->
<!-- DoNotFormat -->

<nav id='uptree' class='flipped tree' style='transform-origin: 50%;'>
  <ul class='root'>
    <li>
      
        <ul>
          
            <li>

  <a href='blog'>
    <div class='text-gray-900 hover:bg-blue-500 hover:text-white cursor-pointer forest-link'>
      Blog
    </div>
  </a>

  
    <ul>
      
        <li>

  <a href=''>
    <div class='text-gray-900 hover:bg-blue-500 hover:text-white cursor-pointer forest-link'>
      Tristan de Cacqueray
    </div>
  </a>

  
</li>
      
    </ul>
  
</li>
          
        </ul>
      
    </li>
  </ul>
</nav>
      

      

      
        <div id='container' class='relative md:shadow-2xl md:mb-8'>
          
  <div class='absolute -top-6 right-1 md:right-0 flex flex-row items-center justify-center'>
    <a title='Search (Ctrl+K)' class='cursor-pointer' onclick='window.emanote.stork.toggleSearch()'>
      <svg xmlns='http://www.w3.org/2000/svg' style='width: 1rem;' class='hover:text-blue-700' f
 fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'>
  <path stroke-linecap='round' stroke-linejoin='round' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'></path>
</svg>
    </a>
  </div>

          <!-- Main body column -->
          <div class='flex-1 w-full bg-white'>
  <main class='px-4 py-4'>
    <h1 id='ema-title' class='flex items-end justify-center mb-4 p-3 bg-blue-100 text-5xl font-extrabold text-black rounded'>
  <a class='z-40 tracking-tighter '>
    Haskell use cases for ChangeMetrics
  </a>
</h1>

  <span class='text-sm text-right font-mono text-gray-600 block -mt-9 rounded px-1 mb-7 min-h-5'>
    2021-06-01
  </span>


    
      <div class='md:grid md:gap-4 md:grid-cols-8'>
        <div class='md:col-span-6'>
          <article class='overflow-auto'>
  <!-- What goes in this file will appear on top of note body-->
  






    <blockquote class='py-0.5 px-4 mb-3 italic border-l-4 bg-gray-50 text-gray-600 border-gray-400 quote'>
      
    <p class='mb-3'>
      This post was initially published on the Software Factory blog: <a href='https://www.softwarefactory-project.io/practical-haskell-use-cases.html' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>https://www.softwarefactory-project.io/practical-haskell-use-cases.html</a>
    </p>
  
    </blockquote>
  
    <p class='mb-3'>
      This post presents a few practical projects in which we used Haskell succesfully.
    </p>
  
    <p class='mb-3'>
      After using Python type annotations, and then the OCaml type system, a colleague and I started to use Haskell to better define our program. We are satisfied with the initial results, and it is my pleasure to share our use cases.
    </p>
  
    <h2 id='lentille-a-bugzilla-task-data-crawler' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Lentille: a bugzilla task data crawler
  
  <a href='blog/haskell-use-cases#lentille-a-bugzilla-task-data-crawler' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      Our goal was to perform Bugzilla API data processing. The challenge was to query a HTTP API and adapt the responses for our needs.
    </p>
  
    <p class='mb-3'>
      Fortunately, a client library for <a href='https://hackage.haskell.org/package/bugzilla-redhat' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>bugzilla-redhat</a> already existed. It features a convenient <a href='https://hackage.haskell.org/package/bugzilla-redhat-0.3.1/docs/Web-Bugzilla-RedHat-Search.html' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Search</a> module to define search expressions. This allowed us to define our query using type safe operators with this expression:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>searchExpr :: UTCTime -&gt; Text -&gt; SearchExpression
searchExpr sinceTS product = since .&&. linkId .&&. productField
  where
    linkId = BZS.isNotEmpty (BZS.CustomField "ext_bz_bug_map.ext_bz_bug_id")
    productField = BZS.ProductField .==. product
    since = BZS.changedSince sinceTS</code></pre></div>
    <p class='mb-3'>
      Then we used the <a href='https://hackage.haskell.org/package/streaming' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>streaming</a> library to isolate the queries from the processing. This provided an abstraction to handle the results in bulk (independently from the pagination logic). Here is the fetching function, using <a href='https://hackage.haskell.org/package/retry' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>retry</a> to handle network interruptions:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>getBZData :: MonadIO m =&gt; BugzillaSession -&gt; Text -&gt; UTCTime -&gt; Stream (Of TaskData) m ()
getBZData bzSession product since = go 0
  where
    limit = 100

    doGet :: MonadIO m =&gt; Int -&gt; m [Bug]
    doGet offset = liftIO (getBugs bzSession sinceTS product limit offset)

    go offset = do
      -- Retrieve rhbz
      bugs &lt;- lift $ do
        log (LogGetBugs sinceTS offset limit)
        retry (doGet offset)

      -- Create a flat stream of task data
      S.each (concatMap toTaskData bugs)

      -- Keep on retrieving the rest
      unless (length bugs &lt; limit) (go (offset + length bugs))</code></pre></div>
    <p class='mb-3'>
      And here is the stream processing function:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>-- Group by chunk of 500
process :: MonadIO m =&gt; ([TaskData] -&gt; m AddResponse) -&gt; Stream (Of TaskData) m () -&gt; m ()
process postFunc =
  S.print
    . S.mapM (processBatch postFunc)
    . S.mapped S.toList  -- Convert to list (type is Stream (Of [TaskData]) m ())
    . S.chunksOf 500     -- Chop the stream (type is Stream (Stream (Of TaskData) m) m ())</code></pre></div>
    <p class='mb-3'>
      The client library missed a few features that we were able to implement locally. It was easy to integrate the work in progress changes using a <code class='py-0.5 px-0.5 bg-gray-100'>cabal.project</code> file to override the location of a build dependency. For example, we added <a href='https://github.com/juhp/hsbugzilla/pull/15/files' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>support for apikey</a>.
    </p>
  
    <h2 id='monocle-http-api-based-on-protobuf' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Monocle HTTP API based on Protobuf
  
  <a href='blog/haskell-use-cases#monocle-http-api-based-on-protobuf' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      Satisfied with the result of Lentille, we wanted to leverage this strongly typed approach for the API. The goal was to ensure the backend, the workers, and the frontend would use a common and well defined API. Check out this <a href='https://github.com/change-metrics/monocle/blob/master/doc/adr/0010-choice-of-protobuf.md' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Architecture Decision Record</a> for more info.
    </p>
  
    <p class='mb-3'>
      For consistency with the existing code, we used the Protobuf JSON encoding over HTTP. This allowed us to write a simple code generator for javascript <code class='py-0.5 px-0.5 bg-gray-100'>axios</code> client and python <code class='py-0.5 px-0.5 bg-gray-100'>flask</code> endpoint using the <a href='https://hackage.haskell.org/package/language-protobuf' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>language-protobuf</a> library. However we had issues with inconsistent JSON encoding. For example, this protobuf message:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='protobuf language-protobuf'>message AddResponse {
  oneof result {
    TaskDataCommitSuccess success = 1;
    TaskDataCommitError error = 2;
  }
}</code></pre></div>
    <p class='mb-3'>
      â€¦ has two encodings: the python implementation produces <code class='py-0.5 px-0.5 bg-gray-100'>{"result": {"success": "ok"}}</code> while the ocaml implementation expects <code class='py-0.5 px-0.5 bg-gray-100'>{"success": "ok"}</code>. Fortunately, the Haskell implementation <a href='https://hackage.haskell.org/package/proto3-suite' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>proto3-suite</a> correctly handles both formats.
    </p>
  
    <p class='mb-3'>
      Another issue that came up was about the Timestamp message from the Google protobuf well known type library. The official <code class='py-0.5 px-0.5 bg-gray-100'>protoc-compiler</code> transparently encodes this message as a rfc3339 string. We had to create a <a href='https://github.com/awakesecurity/proto3-suite/pull/150' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>custom timestamp decoder</a>.
    </p>
  
    <h2 id='monocle-search-query' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Monocle Search Query
  
  <a href='blog/haskell-use-cases#monocle-search-query' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      Our goal was to improve the query interface by replacing a filters form with a query language. The challenge was to support text based query such as <code class='py-0.5 px-0.5 bg-gray-100'>(repo:openstack/nova or repo:openstack/ironic) and score&gt;200</code>. Check out the <a href='https://github.com/change-metrics/monocle/blob/master/doc/adr/0011-search-query-language.md' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>language architecture decision record</a> for more info.
    </p>
  
    <p class='mb-3'>
      Inspired by the work of Gabriel Gonzalez on interpreters, we used <a href='https://hackage.haskell.org/package/megaparsec' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>megaparsec</a> to implement the language:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>lexer :: Text           -&gt; Either ParseError [LocatedToken]
parse :: [LocatedToken] -&gt; Either ParseError Expr
compile :: Expr         -&gt; Either ParseError Query</code></pre></div>
    <p class='mb-3'>
      The query text was compiled to an Elastic search query with the <a href='https://hackage.haskell.org/package/bloodhound' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>bloodhound</a> library and they are served through a <a href='https://hackage.haskell.org/package/servant' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>servant</a> API. Using Servant required enabling complex extensions. Fortunately, the <a href='https://docs.servant.dev/en/stable/tutorial/ApiType.html' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>tutorial</a> explained everything we needed to know. Here is the new search API defined as a Haskell type:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>type MonocleAPI =
       "search_fields" :&gt; ReqBody '[PBJSON] FieldsRequest :&gt; Post '[PBJSON] FieldsResponse
  :&lt;|&gt; "changes" :&gt; ReqBody '[PBJSON] ChangesQueryRequest :&gt; Post '[PBJSON] ChangesQueryResponse</code></pre></div>
    <h2 id='lentille-graphql-client-for-github-and-gitlab' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Lentille GraphQL client for GitHub and GitLab
  
  <a href='blog/haskell-use-cases#lentille-graphql-client-for-github-and-gitlab' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      Our goal was to perform data processing of GraphQL APIs. The challenge was to integrate complex queries defined using an extra language.
    </p>
  
    <p class='mb-3'>
      We used the <a href='https://hackage.haskell.org/package/morpheus-graphql' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>morpheus-graphql</a> library to compile our GraphQL requests into Haskell functions.
    </p>
  
    <p class='mb-3'>
      We were able to re-use the streaming api we previously wrote. Here is the fetching function that handles pagination cursor:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>streamFetch ::
  (MonadIO m, Fetch a, FromJSON a) =&gt;
  GitHubGraphClient -&gt;
  -- | query Args constructor, the function takes a cursor
  (Text -&gt; Args a) -&gt;
  -- | query result adapter
  (a -&gt; (PageInfo, RateLimit, [Text], [b])) -&gt;
  Stream (Of b) m ()
streamFetch client mkArgs transformResponse = go Nothing
  where
    go pageInfoM = do
      respE &lt;-
        fetch
          (runGithubGraphRequest client)
          (mkArgs (fromMaybe (error "Missing endCursor") (maybe (Just "") endCursor pageInfoM)))
      let (pageInfo, rateLimit, decodingErrors, xs) = case respE of
            Left err -&gt; error (toText err)
            Right resp -&gt; transformResponse resp

      -- TODO: report decoding error
      unless (null decodingErrors) (error ("Decoding failed: " &lt;&gt; show decodingErrors))
      logStatus pageInfo rateLimit

      -- Create a stream of 'b'
      S.each xs

      -- Keep on retrieving the rest, TODO: implement throttle
      when (hasNextPage pageInfo) (go (Just pageInfo))</code></pre></div>
    <p class='mb-3'>
      Similar to Servant, using Morpheus GraphQL adds strong guarantees to our code. This comes at the cost of tediously handling complex data types. Fortunately, Haskell features pattern synonyms, which make the pattern matching on deeply nested structure a bit more manageable. Here is an example pattern to match the labels of a GitHub issue:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>pattern IssueLabels nodesLabel
  &lt;- SearchNodesIssue _ _ _ _ (Just (SearchNodesLabelsLabelConnection (Just nodesLabel))) _</code></pre></div>
    <h2 id='gerritbot-for-matrix' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Gerritbot for Matrix
  
  <a href='blog/haskell-use-cases#gerritbot-for-matrix' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      The goal was to implement a service to forward Gerrit events to Matrix rooms. The challenge was to adapt a stream of events into HTTP queries.
    </p>
  
    <p class='mb-3'>
      I created interfaces for both processes:
    </p>
  
    <ul class='my-3 ml-6 space-y-1 list-disc'>
      
        <li>
          a matrix client using <a href='https://hackage.haskell.org/package/aeson' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>aeson</a> and <a href='https://hackage.haskell.org/package/http-client' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>http-client</a>, and
        </li>
      
        <li>
          a ssh command wrapper using the <a href='https://hackage.haskell.org/package/turtle' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>turtle</a> library.
        </li>
      
    </ul>
  
    <p class='mb-3'>
      Then I used the <a href='https://hackage.haskell.org/package/stm' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>stm</a> library to implement safe concurrent process. Here is the helper function to implement a buffered queue:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>bufferQueueRead :: Int -&gt; TBMQueue a -&gt; IO [a]
bufferQueueRead maxTime tqueue = do
  event &lt;- fromMaybe (error "Queue is closed") &lt;$&gt; atomically (TBMQueue.readTBMQueue tqueue)
  threadDelay maxTime
  atomically (drainQueue [event])
  where
    drainQueue acc = do
      event &lt;- fromMaybe (error "Queue is closed") &lt;$&gt; TBMQueue.tryReadTBMQueue tqueue
      case event of
        Nothing -&gt; pure (reverse acc)
        Just ev -&gt; drainQueue (ev : acc)</code></pre></div>
    <p class='mb-3'>
      I also used <a href='https://hackage.haskell.org/package/optparse-generic-1.4.4/docs/Options-Generic.html' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Options.Generic</a> to define the CLI API as a Haskell data type:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>data CLI w = CLI
  { gerritHost :: w ::: Text &lt;?&gt; "The gerrit host",
    gerritUser :: w ::: Text &lt;?&gt; "The gerrit username",
    matrixUrl :: w ::: Text &lt;?&gt; "The matrix url",
    configFile :: w ::: FilePath &lt;?&gt; "The gerritbot.dhall path",
    syncClient :: w ::: Bool &lt;?&gt; "Sync matrix status (join rooms)"
  }</code></pre></div>
    <p class='mb-3'>
      â€¦ and <a href='https://hackage.haskell.org/package/dhall' class='text-blue-600 hover:underline' data-linkicon='external' target='_blank' rel='noopener'>Dhall.TH</a> to derive data types from the configuration file schema:
    </p>
  <div class='py-0.5 mb-3 text-sm'><pre><code class='haskell language-haskell'>Dhall.TH.makeHaskellTypes
  [ Dhall.TH.MultipleConstructors "EventType" "./src/EventType.dhall",
    Dhall.TH.SingleConstructor "Channel" "Channel" "(./src/Config.dhall).Type"
  ]</code></pre></div>
    <p class='mb-3'>
      These strongly type interfaces allowed me to safely add new features without breaking the service. I was able to keep the service running during development without any interruptions.
    </p>
  
    <h2 id='conclusion' class='group mt-6 mb-4 font-bold text-gray-700 text-4xl'>
      
  Conclusion
  
  <a href='blog/haskell-use-cases#conclusion' class='--ema-anchor'>
    <span class='hover:text-blue-400 group-hover:visible invisible cursor-pointer text-sm align-middle' aria-label='Copy link'><svg class='inline w-4' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
        <path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'></path>
        <path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'></path>
      </svg></span>
  </a>


    </h2>
  
    <p class='mb-3'>
      Haskell is designed to enable efficient programing. There is a wealth of libraries with which to compose, and thanks to the Haddock documentation system, we were able to integrate many of them.
    </p>
  
    <p class='mb-3'>
      The type system makes code refactoring and code review really easy. It lets us focus on the core logic without having to worry about entire classes of bugs. In particular, Haskell helps us break monolith programs into well defined and re-usable functions. Being able to move the code fearlessly is incredibly powerfull.
    </p>
  
    <p class='mb-3'>
      Moreover, the Haskell community is constantly producing interesting work. It is fascinating to see such progress in the development of a language.
    </p>
  
    <p class='mb-3'>
      However, the learning curve is rather steep. We spent a lot of time fighting with errors produced by the type checker. While the editor support really helped, getting the code to compile was a challenge.
    </p>
  
    <p class='mb-3'>
      Haskell compiler is currently very slow, and we had to do extra work to keep the continuous integration build time reasonable. A clean build of all our dependencies took 30 minutes, and we had to create a cumbersome layered container to keep the build time under 5 minutes.
    </p>
  
    <p class='mb-3'>
      The Haskell syntax creates undesirable frictions for new contributors because it initially looks strange. After getting over the bump, the language makes a lot of sense and it is not difficult to learn.
    </p>
  
    <p class='mb-3'>
      In the end, we are happy with the results, and the benefits of using Haskell quickly outweight the cost.
    </p>
  
    <p class='mb-3'>
      Thanks for your time!
    </p>
  
  <!-- What goes in this file will appear below the note body-->
</article>
        </div>
        <div class='hidden md:block md:col-span-2 md:border-l'>
          <nav id='toc' class='hidden leading-relaxed md:block md:sticky md:top-0 md:max-h-screen md:overflow-y-auto'>
  <div class='text-gray-600 text-sm'>
    <a class='ml-1 cursor-pointer p-0.5' title='Title' id='--ema-title-toc'>Title</a>
    
        <ul class='ml-2'>
          
            <li class='whitespace-nowrap truncate mt-2' title='Lentille: a bugzilla task data crawler'>
              <a href='blog/haskell-use-cases#lentille-a-bugzilla-task-data-crawler' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Lentille: a bugzilla task data crawler
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Monocle HTTP API based on Protobuf'>
              <a href='blog/haskell-use-cases#monocle-http-api-based-on-protobuf' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Monocle HTTP API based on Protobuf
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Monocle Search Query'>
              <a href='blog/haskell-use-cases#monocle-search-query' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Monocle Search Query
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Lentille GraphQL client for GitHub and GitLab'>
              <a href='blog/haskell-use-cases#lentille-graphql-client-for-github-and-gitlab' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Lentille GraphQL client for GitHub and GitLab
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Gerritbot for Matrix'>
              <a href='blog/haskell-use-cases#gerritbot-for-matrix' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Gerritbot for Matrix
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
            <li class='whitespace-nowrap truncate mt-2' title='Conclusion'>
              <a href='blog/haskell-use-cases#conclusion' class='--ema-toc bg-blue-200 rounded-md p-0.5'>
                Conclusion
              </a>
              
        <ul class='ml-2'>
          
        </ul>
      
            </li>
          
        </ul>
      
  </div>
  <script>
    // Highlight the TOC, based from https://stackoverflow.com/a/75346369
    // TODO: We should get rid of JavaScript! See https://github.com/srid/emanote/issues/520
    function highlightTOC() {
      // Setup title link
      const titleToc = document.querySelectorAll("nav > div > a#--ema-title-toc");
      if (titleToc.length) {
        titleToc[0].onclick = () => {
          document.querySelectorAll("h1#ema-title")[0].scrollIntoView({ behavior: "smooth"});
          history.pushState("", document.title, window.location.pathname + window.location.search);
        }
      }
      // Grab the toc links
      const links = document.querySelectorAll("ul > li > a.--ema-toc");

      // Find the matching anchors in the document body
      const sections = [];
      links.forEach((link) => {
        let found = {};
        for (section of document.querySelectorAll("a.--ema-anchor")) {
          if (link.href == section.href) {
            found = section;
            break;
          }
        }
        sections.push(found);
      });

      // Current toc link is marked with the following class
      const mark = "toc-item-active";

      // Set window scroll handler to update the toc mark.
      window.onscroll = () => {
        // Remove previous mark
        links.forEach((link) => {
          link.classList.remove(mark);
        });

        // Mark the link of the section that is in view, starting from the end
        let marked = false;
        for (var i = sections.length - 1; i >= 0; i--) {
          if (window.scrollY > sections[i].offsetTop - 20) {
            links[i].classList.add(mark);
            marked = true;
            break;
          }
        }

        // Special case for the first and last section which might not reach the top
        if (!marked && window.scrollY > 0) {
          let i = 0;
          if ((window.innerHeight + Math.round(window.scrollY)) >= document.body.offsetHeight) {
            // We are at the bottom
            i = links.length - 1
          }
          links[i].classList.add(mark);
        }
      };
    }
    highlightTOC();
  </script>
</nav>

        </div>
      </div>
      
    <div class='flex flex-col lg:flex-row lg:space-x-2'>
      
      
    </div>
    
  <section class='flex flex-wrap items-end justify-center my-4 space-x-2 space-y-2 font-mono text-sm'>
    
      <!-- FIXME: The use of -/tags is wrong, because we should use routeUrl using Ema's encoder
        Perhaps Emanote should inject tagMetas with urls.
      -->
      <a title='Tag' class='px-1 bg-gray-100 rounded hover:bg-gray-50 hover:text-blue-500' href='-/tags/blog'>
        <!-- DoNotFormat -->
        #blog
        <!-- DoNotFormat -->
      </a>
    
      <!-- FIXME: The use of -/tags is wrong, because we should use routeUrl using Ema's encoder
        Perhaps Emanote should inject tagMetas with urls.
      -->
      <a title='Tag' class='px-1 bg-gray-100 rounded hover:bg-gray-50 hover:text-blue-500' href='-/tags/monocle'>
        <!-- DoNotFormat -->
        #monocle
        <!-- DoNotFormat -->
      </a>
    
  </section>
  <div class='flex items-center justify-center mt-2'>
    <a class='text-gray-300 hover:text-blue-600 text-sm' title='Edit this page on GitHub' href='https://github.com/TristanCacqueray/TristanCacqueray.github.io/edit/main/content/blog/haskell-use-cases.md'>
      <svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z'></path>
      </svg>
    </a>
    <p class='text-sm text-gray-600 mx-2'>
      This work is licensed under a <a class='hover:underline' href='http://creativecommons.org/licenses/by/4.0/'>Creative Commons Attribution 4.0 International License</a>
    </p>
  </div>


    <!-- What goes in this file will at the very end of the main div -->
  </main>
</div>
        </div>
      
      <footer class='flex items-center justify-center mt-2 mb-8 space-x-4 text-center text-gray-800'>
  
  <div>
    <a href='' title='Go to Home page'>
      <svg xmlns='http://www.w3.org/2000/svg' class='w-6 h-6 hover:text-blue-700' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'></path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/all' title='View Index'>
      <svg class='w-6 h-6 hover:text-blue-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='-/tags' title='View tags'>
      <svg class='w-6 h-6 hover:text-blue-700' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z'>
        </path>
      </svg>
    </a>
  </div>
  <div>
    <a href='https://emanote.srid.ca' target='_blank' title='Generated by Emanote 1.3.17.1'>
      <img class='w-6 h-6 hover:text-blue-700' src='_emanote-static/emanote-logo.svg' />
    </a>
  </div>
</footer>

    </div>
  
  <div id='stork-search-container' class='hidden fixed w-screen h-screen inset-0 backdrop-filter backdrop-blur-sm'>
  <div class='fixed w-screen h-screen inset-0' onclick='window.emanote.stork.toggleSearch()'></div>

  <div class='container mx-auto p-10 mt-10'>
    <div class='stork-wrapper-flat container mx-auto'>
      <input id='stork-search-input' data-stork='emanote-search' class='stork-input' placeholder='Search (Ctrl+K) ...' />
      <div data-stork='emanote-search-output' class='stork-output'></div>
    </div>
  </div>
</div>
  
    
  
</body>

</html>

